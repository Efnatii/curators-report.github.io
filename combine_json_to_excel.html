              <div class="file-picker file-picker--dual">
                <input id="jsonFiles" type="file" accept="application/json,.json" multiple class="file-input file-input--hidden" />
                <input id="jsonFolder" type="file" accept="application/json,.json" webkitdirectory class="file-input file-input--hidden" />
                <div class="file-picker__control">
                  <div class="file-picker__buttons">
                    <button id="pickFilesBtn" type="button" class="file-picker__button">Выбрать файлы</button>
                    <button id="pickFolderBtn" type="button" class="file-picker__button file-picker__button--ghost">Выбрать папку</button>
                  </div>
                  <div class="file-picker__meta">
                    <div class="file-picker__counts">
                      <span class="file-picker__count" id="countFiles">Файлы: 0</span>
                      <span class="file-picker__count" id="countFolder">Папка: 0</span>
                      <span class="file-picker__count file-picker__count--accent" id="countTotal">Всего JSON: 0</span>
                    </div>
                    <span class="file-picker__hint">Можно выбрать как отдельные JSON, так и целую папку с ними</span>
                  </div>
        const combineBtn = document.getElementById("combineBtn");
        const fileInput = document.getElementById("jsonFiles");
        const folderInput = document.getElementById("jsonFolder");
        const pdfCheckbox = document.getElementById("generatePdfs");
        const pickFilesBtn = document.getElementById("pickFilesBtn");
        const pickFolderBtn = document.getElementById("pickFolderBtn");
        const countFiles = document.getElementById("countFiles");
        const countFolder = document.getElementById("countFolder");
        const countTotal = document.getElementById("countTotal");
        combineBtn.disabled = true;
        const setStatus = (message, isError = false) => {
          statusEl.textContent = message;
          statusEl.style.color = isError ? "#ffb4b4" : "#dfe5f5";
        };

        const asArray = (fileList) => (fileList ? Array.from(fileList) : []);
        const filterJsonFiles = (files) =>
          files.filter((file) => file.name.toLowerCase().trim().endsWith(".json"));
        const getSelectedFiles = () => {
          return filterJsonFiles([...asArray(fileInput.files), ...asArray(folderInput.files)]);
        };

        const updateCounters = () => {
          const filesFromPicker = filterJsonFiles(asArray(fileInput.files));
          const filesFromFolder = filterJsonFiles(asArray(folderInput.files));
          const total = filesFromPicker.length + filesFromFolder.length;

          countFiles.textContent = `Файлы: ${filesFromPicker.length}`;
          countFolder.textContent = `Папка: ${filesFromFolder.length}`;
          countTotal.textContent = `Всего JSON: ${total}`;

          setStatus(total ? `Выбрано файлов: ${total}` : "Ожидание файлов…");
        };
        const formatScalarList = (items) => {
          return [...items].map((item) => String(item)).sort((a, b) => a.localeCompare(b)).join(", ");
        };
        const normalizeCellValue = (value) => {
          if (value === null || typeof value === "string" || typeof value === "number" || typeof value === "boolean") {
            return value;
          }
          if (Array.isArray(value) && value.every((item) => typeof item !== "object")) {
            return formatScalarList(value);
          }
          return JSON.stringify(value, null, 2);
        };

        pickFilesBtn.addEventListener("click", () => fileInput.click());
        pickFolderBtn.addEventListener("click", () => folderInput.click());
        [fileInput, folderInput].forEach((input) => input.addEventListener("change", updateCounters));
        const bootstrap = async () => {
          setStatus("Загружаем библиотеки…");
          await loadXlsxLibrary();
          await loadLibrary("jsPDF", [
            "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",
            "https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js",
          ]);
          setStatus("Ожидание файлов…");
          combineBtn.disabled = false;
        };
        await bootstrap();
        updateCounters();
        combineBtn.addEventListener("click", async () => {
          const files = getSelectedFiles();
          if (!files.length) {
            setStatus("Сначала выберите хотя бы один JSON-файл", true);
            return;
          }
          combineBtn.disabled = true;
          setStatus("Обработка файлов… это может занять немного времени.");

          try {
            if (pdfCheckbox.checked) {
              const pdfSections = records.map(([name, record]) => buildPdfSection(name, record));
              const pdfContent = buildPdf(pdfSections);
              const blob = new Blob([pdfContent], { type: "application/pdf" });
              const url = URL.createObjectURL(blob);
              const link = document.createElement("a");
              link.href = url;
              link.download = "combined_scores.pdf";
              document.body.appendChild(link);
              link.click();
              link.remove();
              URL.revokeObjectURL(url);
            }
            setStatus(`Готово! Сохранён файл ${filename}${pdfCheckbox.checked ? " и общий PDF-отчёт" : ""}.`);
          } catch (err) {
            console.error(err);
            setStatus(err.message || String(err), true);
          } finally {
            combineBtn.disabled = false;
          }
        });
