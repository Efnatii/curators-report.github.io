<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Отчет по кураторской деятельности</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="hero">
    <div class="container hero__content">
      <div class="hero__badge">Анкета</div>
      <h1>Отчет по кураторской деятельности</h1>
      <p class="lede">Анкета для фиксации данных кураторской деятельности.</p>
    </div>
  </header>

  <main>
    <div class="container">
      <form id="curator-form" class="form">
        <section class="form-section" aria-labelledby="section-general">
          <div class="section-header">
            <div>
              <p class="section-counter">Раздел 1 из 10</p>
              <h2 id="section-general">Общие сведения о кураторе</h2>
              <p class="muted">Вводная информация для идентификации куратора и его группы.</p>
            </div>
            <span class="chip">Обязательный</span>
          </div>
          <div class="field-grid">
            <label class="field">
              <span class="field__label">Фамилия Имя Отчество *</span>
              <input type="text" name="full_name" placeholder="Например, Иванов Иван Иванович" required />
            </label>
            <div class="field field--wide">
              <div class="field__label-row">
                <span class="field__label">Должность *</span>
                <button type="button" class="chip chip--interactive" data-add="job_positions">Добавить</button>
              </div>
              <div class="multi-input" data-name="job_positions">
                <div class="multi-input__row">
                  <input type="text" name="job_position" placeholder="Например, старший преподаватель" required />
                  <button type="button" class="multi-input__remove" aria-label="Удалить запись">&times;</button>
                </div>
              </div>
              <p class="helper">Добавляйте по одной должности в каждую строку.</p>
            </div>
            <label class="field">
              <span class="field__label">Кафедра *</span>
              <input type="text" name="department" placeholder="Например, кафедра компьютерных систем" required />
            </label>
            <label class="field">
              <span class="field__label">Контактный телефон (подключенный к Telegram) *</span>
              <input type="tel" name="contact_phone_connected_to_telegram" placeholder="Например, +7 999 000-00-00" required />
            </label>
            <label class="field">
              <span class="field__label">Ник в Telegram *</span>
              <input type="text" name="telegram_username" placeholder="Например, @curator_help" required />
            </label>
            <label class="field">
              <span class="field__label">E-mail *</span>
              <input type="email" name="email" placeholder="Например, curator@example.ru" required />
            </label>
            <div class="field field--wide">
              <div class="field__label-row">
                <span class="field__label">Номера курируемых групп *</span>
                <button type="button" class="chip chip--interactive" data-add="curated_group_numbers">Добавить</button>
              </div>
              <div class="multi-input" data-name="curated_group_numbers">
                <div class="multi-input__row">
                  <input type="text" name="curated_group_number" placeholder="Например, 1234 или 4102" required />
                  <button type="button" class="multi-input__remove" aria-label="Удалить запись">&times;</button>
                </div>
              </div>
              <p class="helper">Добавьте по одному номеру группы в каждую строку.</p>
            </div>
            <label class="field">
              <span class="field__label">Корпус основного пребывания куратора *</span>
              <input type="text" name="curator_primary_building" placeholder="Например, корпус 1" required />
            </label>
            <label class="field">
              <span class="field__label">Аудитория основного пребывания куратора *</span>
              <input type="text" name="curator_primary_room" placeholder="Например, аудитория 301" required />
            </label>
          </div>
          <fieldset class="choice-card">
            <legend>Институт/Факультет *</legend>
            <div class="choices">
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт аэрокосмических приборов и систем" />
                <span>Институт аэрокосмических приборов и систем</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт радиотехники и инфокоммуникационных технологий" />
                <span>Институт радиотехники и инфокоммуникационных технологий</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт кибербезопасности и цифровых технологий" />
                <span>Институт кибербезопасности и цифровых технологий</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт информационных технологий и программирования" />
                <span>Институт информационных технологий и программирования</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт фундаментальной подготовки и технологических инноваций" />
                <span>Институт фундаментальной подготовки и технологических инноваций</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Гуманитарный факультет" />
                <span>Гуманитарный факультет</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт технологий предпринимательства и права" />
                <span>Институт технологий предпринимательства и права</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Военный учебный центр при ГУАП (ВУЦ)" />
                <span>Военный учебный центр при ГУАП (ВУЦ)</span>
              </label>
            </div>
          <p class="helper">Выберите один или несколько вариантов.</p>
        </fieldset>
      </section>

        <section class="form-section" aria-labelledby="section-curator-hours">
          <div class="section-header">
            <div>
              <p class="section-counter">Раздел 2 из 10</p>
              <h2 id="section-curator-hours">Информация о проведении кураторских часов</h2>
              <p class="muted">Данные о количестве, тематиках и направлениях проведённых кураторских часов</p>
            </div>
            <span class="chip">Обязательный</span>
          </div>

          <fieldset class="choice-card">
            <legend class="field__label">Проведение не менее трех кураторских часов за отчетный период *</legend>
            <div class="choices">
              <label class="choice">
                <input type="radio" name="held_minimum_three_curator_sessions_in_reporting_period" value="true" required />
                <span>Да</span>
              </label>
              <label class="choice">
                <input type="radio" name="held_minimum_three_curator_sessions_in_reporting_period" value="false" required />
                <span>Нет</span>
              </label>
            </div>
          </fieldset>

          <div id="curator-hours-details" class="form-subsection" hidden>
            <div class="section-header section-header--sub">
              <div>
                <p class="section-counter">Дополнительный вопрос</p>
                <h3>Даты проведения трех и более кураторских часов в течение отчетного периода</h3>
                <p class="muted">Заполните данные по каждому проведенному кураторскому часу.</p>
              </div>
              <button type="button" class="chip chip--interactive" id="add-curator-hour-row">Добавить строку</button>
            </div>

            <div class="curator-hours" id="curator-hours-rows"></div>
            <p class="helper">Укажите минимум три записи с деталями каждого кураторского часа.</p>
          </div>
        </section>

        <div class="actions">
          <button type="button" id="download" class="button">Скачать ответы</button>
          <p class="muted">Кнопка сформирует JSON-файл с вашими ответами.</p>
        </div>
      </form>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer__content">
      <div class="footer__links">
        <a href="#section-general">К началу формы</a>
      </div>
    </div>
  </footer>

  <script>
    const form = document.getElementById('curator-form');
    const downloadButton = document.getElementById('download');
    const curatorHoursDetails = document.getElementById('curator-hours-details');
    const curatorHoursRows = document.getElementById('curator-hours-rows');
    const addCuratorHourRowButton = document.getElementById('add-curator-hour-row');

    const directionsOptions = [
      'Гражданская',
      'Патриотическая',
      'Духовно-нравственная',
      'Волонтерская (добровольческая)',
      'Культурно-творческая',
      'Научно-образовательная',
      'Спортивно-оздоровительная',
      'Экологическая',
      'Информационная (коммуникационная)',
      'Туристическая',
      'Предпринимательская',
      'Корпоративная идентичность',
      'Профессионально-трудовая',
    ];

    function createRow(inputName, placeholder = '') {
      const row = document.createElement('div');
      row.className = 'multi-input__row';

      const input = document.createElement('input');
      input.type = 'text';
      input.name = inputName;
      input.required = true;
      input.placeholder = placeholder;

      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'multi-input__remove';
      removeButton.setAttribute('aria-label', 'Удалить запись');
      removeButton.textContent = '×';

      row.append(input, removeButton);
      return row;
    }

    function setupMultiInput({ name, inputName, placeholder = '' }) {
      const container = form.querySelector(`[data-name="${name}"]`);
      const addButton = form.querySelector(`[data-add="${name}"]`);

      if (!container || !addButton) return;

      function updateRemoveState() {
        const rows = container.querySelectorAll('.multi-input__row');
        rows.forEach((row) => {
          const removeButton = row.querySelector('.multi-input__remove');
          if (!removeButton) return;
          const isDisabled = rows.length === 1;
          removeButton.disabled = isDisabled;
        });
      }

      function attachRemove(row) {
        const removeButton = row.querySelector('.multi-input__remove');
        if (!removeButton) return;
        removeButton.addEventListener('click', () => {
          if (container.querySelectorAll('.multi-input__row').length === 1) return;
          row.remove();
          updateRemoveState();
        });
      }

      container.querySelectorAll('.multi-input__row').forEach((row) => attachRemove(row));

      addButton.addEventListener('click', () => {
        const newRow = createRow(inputName, placeholder);
        attachRemove(newRow);
        container.append(newRow);
        updateRemoveState();
      });

      updateRemoveState();
    }

    function collectFaculties() {
      return Array.from(form.querySelectorAll('input[name="institute_or_faculty"]:checked')).map((input) => input.value);
    }

    function getBooleanRadio(name) {
      const selected = form.querySelector(`input[name="${name}"]:checked`);
      if (!selected) return null;
      return selected.value === 'true';
    }

    function getSelectedRadio(name) {
      const selected = form.querySelector(`input[name="${name}"]:checked`);
      return selected ? selected.value : '';
    }

    function getValue(name) {
      return form.elements[name]?.value.trim() || '';
    }

    function collectList(name) {
      const container = form.querySelector(`[data-name="${name}"]`);
      if (!container) return [];
      return Array.from(container.querySelectorAll('input'))
        .map((input) => input.value.trim())
        .filter(Boolean);
    }

    function createListRow(placeholder = '') {
      const row = document.createElement('div');
      row.className = 'multi-input__row';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = placeholder;

      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'multi-input__remove';
      removeButton.setAttribute('aria-label', 'Удалить запись');
      removeButton.textContent = '×';

      row.append(input, removeButton);
      return row;
    }

    function setupRowList({ row, target, placeholder = '' }) {
      const listContainer = row.querySelector(`[data-list="${target}"]`);
      const addButton = row.querySelector(`.curator-hours__add-item[data-target="${target}"]`);

      if (!listContainer || !addButton) return;

      function updateRemoveState() {
        const rows = listContainer.querySelectorAll('.multi-input__row');
        rows.forEach((currentRow) => {
          const removeButton = currentRow.querySelector('.multi-input__remove');
          if (!removeButton) return;
          removeButton.disabled = rows.length === 1;
        });
      }

      function attachRemove(listRow) {
        const removeButton = listRow.querySelector('.multi-input__remove');
        if (!removeButton) return;
        removeButton.addEventListener('click', () => {
          if (listContainer.querySelectorAll('.multi-input__row').length === 1) return;
          listRow.remove();
          updateRemoveState();
        });
      }

      const firstRow = createListRow(placeholder);
      attachRemove(firstRow);
      listContainer.append(firstRow);
      updateRemoveState();

      addButton.addEventListener('click', () => {
        const newRow = createListRow(placeholder);
        attachRemove(newRow);
        listContainer.append(newRow);
        updateRemoveState();
      });
    }

    function createDirectionChip(value, container) {
      if (!value || container.querySelector(`[data-direction-value="${value}"]`)) return;
      const chip = document.createElement('span');
      chip.className = 'pill pill--compact';
      chip.dataset.directionValue = value;
      chip.textContent = value;

      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'pill__remove';
      removeButton.setAttribute('aria-label', 'Удалить направление');
      removeButton.textContent = '×';
      removeButton.addEventListener('click', () => chip.remove());

      chip.append(removeButton);
      container.append(chip);
    }

    function setupDirections(row) {
      const select = row.querySelector('.curator-hours__direction-input');
      const addButton = row.querySelector('.curator-hours__add-direction');
      const listContainer = row.querySelector('[data-list="directions"]');

      if (!select || !addButton || !listContainer) return;

      directionsOptions.forEach((option) => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.append(opt);
      });

      addButton.addEventListener('click', () => {
        createDirectionChip(select.value, listContainer);
      });
    }

    function collectDirections(container) {
      if (!container) return [];
      return Array.from(container.querySelectorAll('[data-direction-value]')).map((chip) => chip.dataset.directionValue);
    }

    function collectDynamicList(container) {
      if (!container) return [];
      return Array.from(container.querySelectorAll('input'))
        .map((input) => input.value.trim())
        .filter(Boolean);
    }

    function createCuratorHoursRow() {
      const row = document.createElement('div');
      row.className = 'curator-hours__row';
      row.innerHTML = `
        <div class="curator-hours__grid">
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Группы</span>
              <button type="button" class="chip chip--interactive curator-hours__add-item" data-target="groups">Добавить</button>
            </div>
            <div class="multi-input" data-list="groups"></div>
          </div>
          <div class="field field--compact">
            <span class="field__label">Дата или период</span>
            <div class="date-range">
              <input type="date" class="date-range__start" aria-label="Дата начала" />
              <span class="date-range__dash">—</span>
              <input type="date" class="date-range__end" aria-label="Дата окончания" />
            </div>
            <p class="helper">Оставьте конечную дату пустой, если указана одна дата.</p>
          </div>
          <label class="field field--compact">
            <span class="field__label">Тема</span>
            <input type="text" class="curator-hours__topic" placeholder="Например, профилактическая беседа" />
          </label>
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Направленность</span>
              <button type="button" class="chip chip--interactive curator-hours__add-direction">+</button>
            </div>
            <div class="curator-hours__direction-select">
              <select class="curator-hours__direction-input"></select>
            </div>
            <div class="pill-list" data-list="directions"></div>
          </div>
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Специалисты</span>
              <button type="button" class="chip chip--interactive curator-hours__add-item" data-target="specialists">Добавить</button>
            </div>
            <div class="multi-input" data-list="specialists"></div>
          </div>
        </div>
        <div class="curator-hours__row-actions">
          <button type="button" class="multi-input__remove curator-hours__remove-row" aria-label="Удалить строку">×</button>
        </div>
      `;

      setupRowList({ row, target: 'groups', placeholder: 'Например, 1234' });
      setupRowList({ row, target: 'specialists', placeholder: 'Например, приглашенный спикер' });
      setupDirections(row);

      return row;
    }

    function updateRowRemovalState() {
      const rows = curatorHoursRows.querySelectorAll('.curator-hours__row');
      rows.forEach((row) => {
        const removeButton = row.querySelector('.curator-hours__remove-row');
        if (!removeButton) return;
        removeButton.disabled = rows.length === 1;
      });
    }

    function addCuratorHourRow() {
      const row = createCuratorHoursRow();
      const removeButton = row.querySelector('.curator-hours__remove-row');

      if (removeButton) {
        removeButton.addEventListener('click', () => {
          if (curatorHoursRows.querySelectorAll('.curator-hours__row').length === 1) return;
          row.remove();
          updateRowRemovalState();
        });
      }

      curatorHoursRows.append(row);
      updateRowRemovalState();
    }

    function collectCuratorHoursRows() {
      return Array.from(curatorHoursRows.querySelectorAll('.curator-hours__row'))
        .map((row) => {
          const groups = collectDynamicList(row.querySelector('[data-list="groups"]'));
          const specialists = collectDynamicList(row.querySelector('[data-list="specialists"]'));
          const dateStart = row.querySelector('.date-range__start')?.value || '';
          const dateEnd = row.querySelector('.date-range__end')?.value || '';
          const topic = row.querySelector('.curator-hours__topic')?.value.trim() || '';
          const directions = collectDirections(row.querySelector('[data-list="directions"]'));

          if (!groups.length && !specialists.length && !dateStart && !dateEnd && !topic && !directions.length) {
            return null;
          }

          return { groups, date_start: dateStart, date_end: dateEnd, topic, directions, specialists };
        })
        .filter(Boolean);
    }

    function toggleCuratorHoursDetails() {
      const isHeld = getBooleanRadio('held_minimum_three_curator_sessions_in_reporting_period');
      curatorHoursDetails.hidden = !isHeld;

      if (isHeld && !curatorHoursRows.children.length) {
        addCuratorHourRow();
      }
    }

    function buildReport() {
      const heldMinimumThreeCuratorSessions = getBooleanRadio('held_minimum_three_curator_sessions_in_reporting_period');
      const payload = {
        full_name: getValue('full_name'),
        job_positions: collectList('job_positions'),
        department: getValue('department'),
        contact_phone_connected_to_telegram: getValue('contact_phone_connected_to_telegram'),
        telegram_username: getValue('telegram_username'),
        email: getValue('email'),
        curated_group_numbers: collectList('curated_group_numbers'),
        curator_primary_building: getValue('curator_primary_building'),
        curator_primary_room: getValue('curator_primary_room'),
        held_minimum_three_curator_sessions_in_reporting_period: heldMinimumThreeCuratorSessions,
        institute_or_faculty: collectFaculties(),
        curator_hours_details: heldMinimumThreeCuratorSessions ? collectCuratorHoursRows() : [],
      };
      return JSON.stringify(payload, null, 2);
    }

    function generateFileName() {
      const [lastName = '', firstName = '', patronymic = ''] = getValue('full_name')
        .split(/\s+/)
        .filter(Boolean);
      const parts = ['Отчёт_о_кураторской_деятельности'];

      if (firstName) parts.push(firstName);
      if (lastName) parts.push(lastName);
      if (patronymic) parts.push(patronymic);

      return `${parts.join('_')}.json`;
    }

    setupMultiInput({
      name: 'job_positions',
      inputName: 'job_position',
      placeholder: 'Например, преподаватель-практик или тьютор',
    });

    setupMultiInput({
      name: 'curated_group_numbers',
      inputName: 'curated_group_number',
      placeholder: 'Например, 1234 или 4102',
    });

    addCuratorHourRowButton.addEventListener('click', addCuratorHourRow);

    form
      .querySelectorAll('input[name="held_minimum_three_curator_sessions_in_reporting_period"]')
      .forEach((radio) => radio.addEventListener('change', toggleCuratorHoursDetails));

    toggleCuratorHoursDetails();

    downloadButton.addEventListener('click', () => {
      const report = buildReport();
      const blob = new Blob([report], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = generateFileName();
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
