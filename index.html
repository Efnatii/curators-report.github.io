<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Отчет по кураторской деятельности</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="hero">
    <div class="container hero__content">
      <div class="hero__badge">Анкета</div>
      <h1>Отчет по кураторской деятельности</h1>
      <p class="lede">Анкета для фиксации данных кураторской деятельности.</p>
      <div class="hero__meta" aria-label="Выбор отчетного периода">
        <div class="period-picker">
          <div class="period-picker__row">
            <span class="period-picker__label">Отчетный период</span>
            <select
              id="reporting-period"
              class="period-picker__select"
              aria-label="Выберите отчетный период"
            ></select>
          </div>
          <div class="period-picker__manual" aria-label="Ручной ввод отчетного периода">
            <label class="period-picker__field">
              <span class="period-picker__field-label">Название периода</span>
              <input
                type="text"
                id="reporting-period-label"
                class="period-picker__input"
                placeholder="Например, 1 отчётный период"
              />
            </label>
            <label class="period-picker__field">
              <span class="period-picker__field-label">Дата начала</span>
              <input type="date" id="reporting-period-start" class="period-picker__input" />
            </label>
            <label class="period-picker__field">
              <span class="period-picker__field-label">Дата окончания</span>
              <input type="date" id="reporting-period-end" class="period-picker__input" />
            </label>
            <label class="period-picker__field">
              <span class="period-picker__field-label">Крайний срок отправки</span>
              <input type="date" id="reporting-period-deadline" class="period-picker__input" />
            </label>
          </div>
          <p class="period-picker__hint">Изменяйте значения вручную, если отчётные периоды меняются.</p>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <form id="curator-form" class="form">
        <section class="form-section" aria-labelledby="section-general">
          <div class="section-header">
            <div>
              <p class="section-counter">Раздел 1 из 5</p>
              <h2 id="section-general">Общие сведения о кураторе</h2>
              <p class="muted">Вводная информация для идентификации куратора и его группы.</p>
            </div>
          </div>
          <div class="field-grid">
            <label class="field">
              <span class="field__label">1. Фамилия Имя Отчество *</span>
              <input type="text" name="full_name" placeholder="Например, Иванов Иван Иванович" required />
            </label>
            <div class="field field--wide">
              <div class="field__label-row">
                <span class="field__label">2. Должность *</span>
                <div class="field__meta">
                  <div class="tooltip">
                    <button
                      type="button"
                      class="tooltip__trigger"
                      aria-label="Подсказка: добавляйте по одной должности в каждую строку"
                      aria-expanded="false"
                    >
                      ?
                    </button>
                    <div class="tooltip__bubble" role="tooltip">Добавляйте по одной должности в каждую строку.</div>
                  </div>
                  <button type="button" class="chip chip--interactive" data-add="job_positions">Добавить</button>
                </div>
              </div>
              <div class="multi-input" data-name="job_positions">
                <div class="multi-input__row">
                  <input type="text" name="job_position" placeholder="Например, старший преподаватель" required />
                  <button type="button" class="multi-input__remove" aria-label="Удалить запись">&times;</button>
                </div>
              </div>
            </div>
            <label class="field">
              <span class="field__label">3. Кафедра *</span>
              <input type="text" name="department" placeholder="Например, кафедра компьютерных систем" required />
            </label>
            <label class="field">
              <span class="field__label">4. Контактный телефон (подключенный к Telegram) *</span>
              <input type="tel" name="contact_phone_connected_to_telegram" placeholder="Например, +7 999 000-00-00" required />
            </label>
            <label class="field">
              <span class="field__label">5. Ник в Telegram *</span>
              <input type="text" name="telegram_username" placeholder="Например, @curator_help" required />
            </label>
            <label class="field">
              <span class="field__label">6. E-mail *</span>
              <input type="email" name="email" placeholder="Например, curator@example.ru" required />
            </label>
            <div class="field field--wide">
              <div class="field__label-row">
                <span class="field__label">7. Номера курируемых групп *</span>
                <div class="field__meta">
                  <div class="tooltip">
                    <button
                      type="button"
                      class="tooltip__trigger"
                      aria-label="Подсказка: добавьте по одному номеру группы в каждую строку"
                      aria-expanded="false"
                    >
                      ?
                    </button>
                    <div class="tooltip__bubble" role="tooltip">Добавьте по одному номеру группы в каждую строку.</div>
                  </div>
                  <button type="button" class="chip chip--interactive" data-add="curated_group_numbers">Добавить</button>
                </div>
              </div>
              <div class="multi-input" data-name="curated_group_numbers">
                <div class="multi-input__row">
                  <input type="text" name="curated_group_number" placeholder="Например, 1234 или 4102" required />
                  <button type="button" class="multi-input__remove" aria-label="Удалить запись">&times;</button>
                </div>
              </div>
            </div>
            <label class="field">
              <span class="field__label">8. Корпус основного пребывания куратора *</span>
              <input type="text" name="curator_primary_building" placeholder="Например, корпус 1" required />
            </label>
            <label class="field">
              <span class="field__label">9. Аудитория основного пребывания куратора *</span>
              <input type="text" name="curator_primary_room" placeholder="Например, аудитория 301" required />
            </label>
          </div>
          <fieldset class="choice-card">
            <legend class="legend-with-tooltip">
              <span>10. Институт/Факультет *</span>
              <div class="tooltip">
                <button
                  type="button"
                  class="tooltip__trigger"
                  aria-label="Подсказка: можно выбрать один или несколько вариантов"
                  aria-expanded="false"
                >
                  ?
                </button>
                <div class="tooltip__bubble" role="tooltip">Выберите один или несколько вариантов.</div>
              </div>
            </legend>
            <div class="choices">
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт аэрокосмических приборов и систем" />
                <span>Институт аэрокосмических приборов и систем</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт радиотехники и инфокоммуникационных технологий" />
                <span>Институт радиотехники и инфокоммуникационных технологий</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт киберфизических систем" />
                <span>Институт киберфизических систем</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт информационных технологий и программирования" />
                <span>Институт информационных технологий и программирования</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт фундаментальной подготовки и технологических инноваций" />
                <span>Институт фундаментальной подготовки и технологических инноваций</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Гуманитарный факультет" />
                <span>Гуманитарный факультет</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Институт технологий предпринимательства и права" />
                <span>Институт технологий предпринимательства и права</span>
              </label>
              <label class="choice">
                <input type="checkbox" name="institute_or_faculty" value="Военный учебный центр при ГУАП (ВУЦ)" />
                <span>Военный учебный центр при ГУАП (ВУЦ)</span>
              </label>
            </div>
        </fieldset>
      </section>

        <section class="form-section" aria-labelledby="section-curator-hours">
          <div class="section-header">
            <div>
              <p class="section-counter">Раздел 2 из 5</p>
              <h2 id="section-curator-hours">Информация о проведении кураторских часов</h2>
              <p class="muted">Данные о количестве, тематиках и направлениях проведённых кураторских часов</p>
            </div>
          </div>

          <fieldset class="choice-card">
            <legend class="field__label">11. Проведение не менее трех кураторских часов за отчетный период *</legend>
            <div class="choices">
              <label class="choice">
                <input type="radio" name="held_minimum_three_curator_sessions_in_reporting_period" value="true" required />
                <span>Да</span>
              </label>
              <label class="choice">
                <input type="radio" name="held_minimum_three_curator_sessions_in_reporting_period" value="false" required />
                <span>Нет</span>
              </label>
            </div>
          </fieldset>

          <div id="curator-hours-details" class="form-subsection" hidden>
            <div class="section-header section-header--sub">
              <div>
                <p class="section-counter">Дополнительный вопрос</p>
                <h3>12. Даты проведения трех и более кураторских часов в течение отчетного периода</h3>
                <p class="muted">Заполните данные по каждому проведенному кураторскому часу.</p>
              </div>
              <div class="tooltip tooltip--standalone">
                <button
                  type="button"
                  class="tooltip__trigger"
                  aria-label="Подсказка: укажите минимум три записи с деталями каждого кураторского часа"
                  aria-expanded="false"
                >
                  ?
                </button>
                <div class="tooltip__bubble" role="tooltip">Укажите минимум три записи с деталями каждого кураторского часа.</div>
              </div>
              <button type="button" class="chip chip--interactive" id="add-curator-hour-row">Добавить строку</button>
            </div>

            <div class="curator-hours" id="curator-hours-rows"></div>
          </div>
        </section>

        <section class="form-section" aria-labelledby="section-collaboration">
          <div class="section-header">
            <div>
              <p class="section-counter">Раздел 3 из 5</p>
              <h2 id="section-collaboration">Совместные мероприятия с курируемой группой</h2>
              <p class="muted">Отражает совместную активность куратора и студентов.</p>
            </div>
          </div>

          <fieldset class="choice-card">
            <legend class="field__label">13. Ведение чата с каждой группой или общего чата со всеми группами *</legend>
            <div class="choices">
              <label class="choice">
                <input type="radio" name="manages_group_chat" value="true" />
                <span>Да</span>
              </label>
              <label class="choice">
                <input type="radio" name="manages_group_chat" value="false" />
                <span>Нет</span>
              </label>
            </div>
          </fieldset>

          <fieldset class="choice-card">
            <legend class="field__label">14. Информирование группы о мероприятиях и событиях различного уровня *</legend>
            <div class="choices">
              <label class="choice">
                <input type="radio" name="inform_group_about_events" value="true" required />
                <span>Да</span>
              </label>
              <label class="choice">
                <input type="radio" name="inform_group_about_events" value="false" required />
                <span>Нет</span>
              </label>
            </div>
          </fieldset>

          <div id="joint-activities-details" class="form-subsection" hidden>
            <div class="section-header section-header--sub">
              <div>
                  <h3 class="additional-title">Дополнительные вопросы</h3>
              </div>
            </div>

            <div class="form-subsection form-subsection--borderless">
              <div class="section-header section-header--sub">
                <div>
                  <h3>15. Призовое место обучающегося во внеучебных мероприятиях, конкурсах, получение грантов</h3>
                  <p class="muted">Добавьте записи только при наличии результатов. Таблица по умолчанию пустая.</p>
                </div>
                <button type="button" class="chip chip--interactive" id="add-achievement-row">Добавить строку</button>
              </div>
              <div class="achievement-table" id="achievement-rows"></div>
            </div>

            <fieldset class="choice-card">
            <legend class="field__label">16. Совместное участие с группой не менее чем в двух мероприятиях в течение отчетного периода *</legend>
              <div class="choices">
                <label class="choice">
                  <input type="radio" name="participated_in_two_events_with_group" value="true" />
                  <span>Да</span>
                </label>
                <label class="choice">
                  <input type="radio" name="participated_in_two_events_with_group" value="false" />
                  <span>Нет</span>
                </label>
              </div>
            </fieldset>

            <div id="joint-events-details" class="form-subsection" hidden>
              <div class="section-header section-header--sub">
                <div>
                  <p class="section-counter">Дополнительный вопрос</p>
                  <h3>17. Даты проведения двух и более мероприятий в течение отчетного периода</h3>
                  <p class="muted">Заполните данные по каждому совместному мероприятию.</p>
                </div>
                <div class="tooltip tooltip--standalone">
                  <button
                    type="button"
                    class="tooltip__trigger"
                    aria-label="Подсказка: укажите минимум две записи с деталями каждого мероприятия"
                    aria-expanded="false"
                  >
                    ?
                  </button>
                  <div class="tooltip__bubble" role="tooltip">Укажите минимум две записи с деталями каждого мероприятия.</div>
                </div>
                <button type="button" class="chip chip--interactive" id="add-joint-event-row">Добавить строку</button>
              </div>
              <div class="joint-events" id="joint-event-rows"></div>
            </div>
          </div>
        </section>

        <section class="form-section" aria-labelledby="section-curator-extracurricular">
          <div class="section-header">
            <div>
              <p class="section-counter">Раздел 4 из 5</p>
              <h2 id="section-curator-extracurricular">Внеучебная деятельность куратора</h2>
              <p class="muted">Личное участие и наставничество куратора в программах, форумах и конкурсах.</p>
            </div>
          </div>

          <fieldset class="choice-card">
            <legend class="field__label">
              18. Участие не менее чем в двух мероприятиях  для кураторов: собрания, совещания,  тренинги, мастер-классы, конкурс
              кураторов *
            </legend>
            <div class="choices">
              <label class="choice">
                <input type="radio" name="participated_in_two_curator_events" value="true" required />
                <span>Да</span>
              </label>
              <label class="choice">
                <input type="radio" name="participated_in_two_curator_events" value="false" required />
                <span>Нет</span>
              </label>
            </div>
          </fieldset>

          <div id="curator-extracurricular-details" class="form-subsection" hidden>
            <div class="section-header section-header--sub">
              <div>
                <p class="section-counter">Дополнительный вопрос</p>
                <h3>
                  19. Даты участия не менее чем в двух мероприятиях  для кураторов: собрания, совещания, тренинги, мастер-классы,
                  конкурс кураторов
                </h3>
                <p class="muted">Заполните данные по каждому мероприятию.</p>
              </div>
              <div class="tooltip tooltip--standalone">
                <button
                  type="button"
                  class="tooltip__trigger"
                  aria-label="Подсказка: укажите минимум две записи с деталями каждого мероприятия"
                  aria-expanded="false"
                >
                  ?
                </button>
                <div class="tooltip__bubble" role="tooltip">Укажите минимум две записи с деталями каждого мероприятия.</div>
              </div>
              <button type="button" class="chip chip--interactive" id="add-extracurricular-row">Добавить строку</button>
            </div>
            <div class="curator-hours" id="extracurricular-rows"></div>
          </div>

          <div class="form-subsection form-subsection--borderless">
            <div class="section-header section-header--sub">
              <div>
                <h3>
                  20. Личное участие в региональных, межмуниципальных, федеральных программах, конкурсах, мероприятиях по работе с
                  детьми и молодежью, воспитательной работе, молодежной политике (форумы, «Голос поколения», конкурс кураторов РГПУ
                  им. Герцена и т.д.)
                </h3>
                <p class="muted">Добавьте записи по необходимости. Таблица по умолчанию пустая.</p>
              </div>
              <button type="button" class="chip chip--interactive" id="add-personal-program-row">Добавить строку</button>
            </div>
            <div class="curator-hours" id="personal-program-rows"></div>
          </div>

          <div class="form-subsection form-subsection--borderless">
            <div class="section-header section-header--sub">
              <div>
                <h3>
                  21. Участие куратора в роли наставника проекта, а также в подготовке к чемпионату, конкурсу, конференции и др.
                </h3>
                <p class="muted">Добавьте записи только при наличии наставничества. Таблица по умолчанию пустая.</p>
              </div>
              <button type="button" class="chip chip--interactive" id="add-mentor-support-row">Добавить строку</button>
            </div>
            <div class="achievement-table" id="mentor-support-rows"></div>
          </div>
        </section>

        <section class="form-section" aria-labelledby="section-academic">
          <div class="section-header">
            <div>
              <p class="section-counter">Раздел 5 из 5</p>
              <h2 id="section-academic">Научная и методическая деятельность куратора</h2>
              <p class="muted">Публикации, методические материалы, повышение квалификации.</p>
            </div>
          </div>

          <div class="form-subsection form-subsection--borderless">
            <div class="section-header section-header--sub">
              <div>
                <h3>
                  22. Опубликование научной работы (в том числе монографии, научной статьи, доклада, тезисов доклада и т.д. на
                  темы, связанные с молодежной политикой и воспитательной деятельностью, с указанием принадлежности автора к ГУАП
                  (в том числе в форме электронного издания))
                </h3>
                <p class="muted">Добавьте записи при наличии публикаций. Таблица по умолчанию пустая.</p>
              </div>
              <button type="button" class="chip chip--interactive" id="add-scientific-work-row">Добавить строку</button>
            </div>
            <div class="curator-hours" id="scientific-work-rows"></div>
          </div>

          <div class="form-subsection form-subsection--borderless">
            <div class="section-header section-header--sub">
              <div>
                <h3>23. Интервью и статьи для «Дзен.ГУАП», соцсетей и сайта ГУАП</h3>
                <p class="muted">Добавьте ссылки на опубликованные материалы.</p>
              </div>
              <button type="button" class="chip chip--interactive" id="add-interview-row">Добавить строку</button>
            </div>
            <div class="curator-hours" id="interview-rows"></div>
          </div>

          <div class="form-subsection form-subsection--borderless">
            <div class="section-header section-header--sub">
              <div>
                <h3>24. Курсы повышения квалификации в области молодежной политики и воспитательной деятельности</h3>
                <p class="muted">Добавьте записи только при наличии повышения квалификации. Таблица по умолчанию пустая.</p>
              </div>
              <button type="button" class="chip chip--interactive" id="add-qualification-course-row">Добавить строку</button>
            </div>
            <div class="curator-hours" id="qualification-course-rows"></div>
          </div>
        </section>

        <div class="actions">
          <button type="button" id="import-json-button" class="button button--secondary">Импорт из JSON</button>
          <button type="button" id="export-json-button" class="button">Экспорт в JSON</button>
          <button type="button" id="export-pdf-button" class="button">Экспорт в PDF</button>
          <p class="muted">Используйте кнопки, чтобы импортировать ответы или экспортировать их в форматах JSON и PDF.</p>
          <input type="file" id="import-json-input" accept="application/json" hidden />
        </div>
      </form>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer__content">
      <div class="footer__links">
        <a href="#section-general">К началу формы</a>
      </div>
      <p class="footnote">
        © Copyrights —
        <a href="https://github.com/Efnatii" rel="noopener noreferrer">Efnatii</a>
        (Гороховицкий Е. Р.).
        <a href="LICENSE" rel="license noopener noreferrer">MIT License</a>
      </p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/vfs_fonts.js"></script>
  <script>
    const form = document.getElementById('curator-form');
    const reportingPeriodSelect = document.getElementById('reporting-period');
    const reportingPeriodLabelInput = document.getElementById('reporting-period-label');
    const reportingPeriodStartInput = document.getElementById('reporting-period-start');
    const reportingPeriodEndInput = document.getElementById('reporting-period-end');
    const reportingPeriodDeadlineInput = document.getElementById('reporting-period-deadline');
    const importButton = document.getElementById('import-json-button');
    const importInput = document.getElementById('import-json-input');
    const exportJsonButton = document.getElementById('export-json-button');
    const exportPdfButton = document.getElementById('export-pdf-button');
    const curatorHoursDetails = document.getElementById('curator-hours-details');
    const curatorHoursRows = document.getElementById('curator-hours-rows');
    const addCuratorHourRowButton = document.getElementById('add-curator-hour-row');
    const jointActivitiesDetails = document.getElementById('joint-activities-details');
    const addAchievementRowButton = document.getElementById('add-achievement-row');
    const achievementRowsContainer = document.getElementById('achievement-rows');
    const jointEventsDetails = document.getElementById('joint-events-details');
    const jointEventRowsContainer = document.getElementById('joint-event-rows');
    const addJointEventRowButton = document.getElementById('add-joint-event-row');
    const extracurricularDetails = document.getElementById('curator-extracurricular-details');
    const extracurricularRowsContainer = document.getElementById('extracurricular-rows');
    const addExtracurricularRowButton = document.getElementById('add-extracurricular-row');
    const personalProgramRowsContainer = document.getElementById('personal-program-rows');
    const addPersonalProgramRowButton = document.getElementById('add-personal-program-row');
    const mentorSupportRowsContainer = document.getElementById('mentor-support-rows');
    const addMentorSupportRowButton = document.getElementById('add-mentor-support-row');
    const scientificWorkRowsContainer = document.getElementById('scientific-work-rows');
    const addScientificWorkRowButton = document.getElementById('add-scientific-work-row');
    const interviewRowsContainer = document.getElementById('interview-rows');
    const addInterviewRowButton = document.getElementById('add-interview-row');
    const qualificationCourseRowsContainer = document.getElementById('qualification-course-rows');
    const addQualificationCourseRowButton = document.getElementById('add-qualification-course-row');

    const directionsOptions = [
      'Гражданская',
      'Патриотическая',
      'Духовно-нравственная',
      'Волонтерская (добровольческая)',
      'Культурно-творческая',
      'Научно-образовательная',
      'Спортивно-оздоровительная',
      'Экологическая',
      'Информационная (коммуникационная)',
      'Туристическая',
      'Предпринимательская',
      'Корпоративная идентичность',
      'Профессионально-трудовая',
    ];

    function buildReportingPeriodOptions() {
      if (!reportingPeriodSelect) return;

      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();
      const academicYearStart = currentMonth < 5 ? currentYear - 1 : currentYear;
      const academicYearEnd = academicYearStart + 1;
      const periods = [
        {
          id: 'period-1',
          label: '1 отчётный период',
          dateStart: `01.09.${academicYearStart}`,
          dateEnd: `30.11.${academicYearStart}`,
          deadline: `06.12.${academicYearStart}`,
        },
        {
          id: 'period-2',
          label: '2 отчётный период',
          dateStart: `01.12.${academicYearStart}`,
          dateEnd: `31.05.${academicYearEnd}`,
          deadline: `06.05.${academicYearEnd}`,
        },
      ];

      reportingPeriodSelect.innerHTML = '';

      periods.forEach(({ id, label, dateStart, dateEnd, deadline }) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = `${label}: ${dateStart}–${dateEnd} (Прислать отчёт до ${deadline})`;
        option.dataset.dateStart = dateStart;
        option.dataset.dateEnd = dateEnd;
        option.dataset.deadline = deadline;
        option.dataset.label = label;
        reportingPeriodSelect.append(option);
      });

      updateManualPeriodFromSelect();
    }

    function selectReportingPeriod(period) {
      if (!reportingPeriodSelect || !period) return;

      const { label = '', date_start: dateStart = '', date_end: dateEnd = '', deadline = '', display = '' } = period;
      const { start: rangeStart, end: rangeEnd } = splitRange(period.range || '');
      const normalizedStart = dateStart || rangeStart;
      const normalizedEnd = dateEnd || rangeEnd;
      setManualReportingPeriod({ label, dateStart: normalizedStart, dateEnd: normalizedEnd, deadline });
      const matchedOption = Array.from(reportingPeriodSelect.options).find(
        (option) =>
          option.dataset.label === label &&
          option.dataset.dateStart === normalizedStart &&
          option.dataset.dateEnd === normalizedEnd &&
          option.dataset.deadline === deadline
      );

      if (matchedOption) {
        reportingPeriodSelect.value = matchedOption.value;
        return;
      }

      const option = document.createElement('option');
      option.value = 'custom-period';
      option.textContent =
        display || buildReportingPeriodDisplay({ label, dateStart: normalizedStart, dateEnd: normalizedEnd, deadline });
      option.dataset.dateStart = normalizedStart;
      option.dataset.dateEnd = normalizedEnd;
      option.dataset.deadline = deadline;
      option.dataset.label = label;

      reportingPeriodSelect.append(option);
      reportingPeriodSelect.value = option.value;
    }

    const fieldComments = {
      reporting_period: 'Выбранный отчётный период и крайний срок отправки отчёта.',
      _meta: 'Комментарии добавлены для ориентира и не влияют на валидацию данных.',
      full_name: 'Фамилия Имя Отчество куратора.',
      job_positions: 'Список должностей куратора; каждая строка — отдельная должность.',
      department: 'Кафедра или структурное подразделение, в котором работает куратор.',
      contact_phone_connected_to_telegram: 'Контактный телефон, привязанный к аккаунту Telegram.',
      telegram_username: 'Никнейм в Telegram, начиная с @.',
      email: 'Рабочий адрес электронной почты.',
      curated_group_numbers: 'Номера групп, с которыми куратор работает в отчётном периоде.',
      curator_primary_building: 'Корпус основного пребывания куратора.',
      curator_primary_room: 'Аудитория (кабинет), в которой куратор чаще всего находится.',
      institute_or_faculty: 'Институты или факультеты, закреплённые за куратором.',
      held_minimum_three_curator_sessions_in_reporting_period:
        'Отметьте, проведены ли минимум три кураторских часа в отчётный период.',
      curator_hours_details: {
        _comment: 'Детализация проведённых кураторских часов.',
        groups: 'Группы, участвовавшие в занятии (список).',
        specialists: 'Приглашённые специалисты (список).',
        date_start: 'Дата начала или единственная дата занятия.',
        date_end: 'Дата окончания, если занятие длилось несколько дней.',
        topic: 'Тема кураторского часа.',
        directions: 'Направления воспитательной работы, раскрытые на занятии.',
      },
      inform_group_about_events: 'Куратор информирует обучающихся о мероприятиях для участия.',
      achievements: {
        _comment: 'Достижения обучающихся и групп.',
        date_start: 'Дата начала или единственная дата достижения.',
        date_end: 'Дата окончания, если достижение относится к периоду.',
        event: 'Название или описание мероприятия/конкурса.',
        group: 'Номер группы, к которой относится достижение.',
        student: 'ФИО студента или студентов.',
        result: 'Полученный результат: место, статус, грант и т.д.',
      },
      manages_group_chat: 'Куратор администрирует чат или ведёт переписку с группой.',
      participated_in_two_events_with_group: 'Куратор посетил минимум два мероприятия вместе с группой.',
      joint_participation_events: {
        _comment: 'Совместные мероприятия с участием куратора и группы.',
        groups: 'Группы-участники мероприятия (список).',
        date_start: 'Дата начала или основная дата мероприятия.',
        date_end: 'Дата окончания, если мероприятие длилось несколько дней.',
        event: 'Краткое описание или название мероприятия.',
      },
      participated_in_two_curator_events: 'Куратор принял участие минимум в двух мероприятиях для кураторов.',
      curator_personal_events: {
        _comment: 'Сведения о личном участии куратора в программах, форумах и конкурсах.',
        date_start: 'Дата начала или единственная дата участия.',
        date_end: 'Дата окончания периода участия, если применимо.',
        event: 'Название или описание мероприятия.',
      },
      personal_program_participation: {
        _comment:
          'Участие куратора в программах, конкурсах и мероприятиях по работе с молодежью на региональном и федеральном уровнях.',
        date_start: 'Дата начала или единственная дата участия.',
        date_end: 'Дата окончания участия, если мероприятие длилось несколько дней.',
        event: 'Название или описание программы, конкурса или мероприятия.',
      },
      mentor_support_events: {
        _comment:
          'Наставничество куратора в проектах и подготовке к чемпионатам, конкурсам, конференциям и другим мероприятиям.',
        date_start: 'Дата начала или единственная дата наставничества.',
        date_end: 'Дата окончания, если наставничество длилось несколько дней.',
        event: 'Название мероприятия или проекта.',
        group: 'Группа, с которой работал куратор.',
        student: 'ФИО студента или команды.',
        result: 'Результат участия: итог, статус, достижение.',
      },
      scientific_publications: {
        _comment:
          'Сведения об опубликованных научных работах по молодежной политике и воспитательной деятельности с указанием принадлежности к ГУАП.',
        description: 'Вводные данные о публикации: название, тип, соавторы, выходные данные.',
        link: 'Ссылка на интернет-ресурс с опубликованной работой или электронным изданием.',
      },
      media_materials: {
        _comment: 'Интервью и статьи, подготовленные для «Дзен.ГУАП», соцсетей и сайта ГУАП.',
        link: 'Ссылка на опубликованный материал.',
      },
      qualification_courses: {
        _comment: 'Данные о курсах повышения квалификации в области молодежной политики и воспитательной деятельности.',
        date_start: 'Дата начала или единственная дата обучения.',
        date_end: 'Дата окончания курса, если обучение шло периодом.',
        event: 'Название или описание курса.',
      },
    };

    function closeAllTooltips(except = null) {
      document.querySelectorAll('.tooltip.tooltip--active').forEach((tooltip) => {
        if (tooltip === except) return;
        const trigger = tooltip.querySelector('.tooltip__trigger');
        tooltip.classList.remove('tooltip--active');
        if (trigger) {
          trigger.setAttribute('aria-expanded', 'false');
        }
      });
    }

    function createAchievementRow() {
      const row = document.createElement('div');
      row.className = 'achievement-row';

      row.innerHTML = `
        <div class="achievement-grid">
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Дата (дата либо период)</span>
              <div class="tooltip">
                <button
                  type="button"
                  class="tooltip__trigger"
                  aria-label="Подсказка: оставьте конечную дату пустой, если указана одна дата"
                  aria-expanded="false"
                >
                  ?
                </button>
                <div class="tooltip__bubble" role="tooltip">Оставьте конечную дату пустой, если указана одна дата.</div>
              </div>
            </div>
            <div class="date-range">
              <input type="date" class="achievement-date__start" aria-label="Дата начала" />
              <span class="date-range__dash">—</span>
              <input type="date" class="achievement-date__end" aria-label="Дата окончания" />
            </div>
          </div>
          <label class="field field--compact">
            <span class="field__label">Мероприятие</span>
            <textarea name="achievement_event" placeholder="Например, участие в городском конкурсе проектов"></textarea>
          </label>
          <label class="field field--compact">
            <span class="field__label">Группа</span>
            <input type="text" name="achievement_group" placeholder="Например, 4102" />
          </label>
          <label class="field field--compact">
            <span class="field__label">ФИО студента</span>
            <input type="text" name="achievement_student" placeholder="Например, Петрова Анна Сергеевна" />
          </label>
          <label class="field field--compact">
            <span class="field__label">Итог</span>
            <textarea name="achievement_result" placeholder="Например, 2 место, грант на разработку проекта"></textarea>
          </label>
        </div>
        <button type="button" class="multi-input__remove achievement-row__remove" aria-label="Удалить запись">&times;</button>
      `;

      const removeButton = row.querySelector('.achievement-row__remove');
      removeButton.addEventListener('click', () => row.remove());

      return row;
    }

    function createMentorSupportRow() {
      const row = document.createElement('div');
      row.className = 'achievement-row';

      row.innerHTML = `
        <div class="achievement-grid">
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Дата (дата либо период)</span>
              <div class="tooltip">
                <button
                  type="button"
                  class="tooltip__trigger"
                  aria-label="Подсказка: оставьте конечную дату пустой, если указана одна дата"
                  aria-expanded="false"
                >
                  ?
                </button>
                <div class="tooltip__bubble" role="tooltip">Оставьте конечную дату пустой, если указана одна дата.</div>
              </div>
            </div>
            <div class="date-range">
              <input type="date" class="mentor-support-date__start" aria-label="Дата начала" />
              <span class="date-range__dash">—</span>
              <input type="date" class="mentor-support-date__end" aria-label="Дата окончания" />
            </div>
          </div>
          <label class="field field--compact">
            <span class="field__label">Мероприятие</span>
            <textarea name="mentor_support_event" placeholder="Например, подготовка к конференции или чемпионату"></textarea>
          </label>
          <label class="field field--compact">
            <span class="field__label">Группа</span>
            <input type="text" name="mentor_support_group" placeholder="Например, 4102" />
          </label>
          <label class="field field--compact">
            <span class="field__label">ФИО студента</span>
            <input type="text" name="mentor_support_student" placeholder="Например, Иванова Елена Петровна" />
          </label>
          <label class="field field--compact">
            <span class="field__label">Итог</span>
            <textarea name="mentor_support_result" placeholder="Например, вышли в финал конкурса"></textarea>
          </label>
        </div>
        <button type="button" class="multi-input__remove achievement-row__remove" aria-label="Удалить запись">&times;</button>
      `;

      const removeButton = row.querySelector('.achievement-row__remove');
      removeButton.addEventListener('click', () => row.remove());

      return row;
    }

    function createJointEventRow({ isRemovable = true } = {}) {
      const row = document.createElement('div');
      row.className = 'joint-events__row';

      row.innerHTML = `
        <div class="joint-events__grid">
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Группы</span>
              <button
                type="button"
                class="chip chip--interactive curator-hours__add-item joint-events__add-item"
                data-target="groups"
              >
                Добавить
              </button>
            </div>
            <div class="multi-input" data-list="groups"></div>
          </div>
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Дата (дата или период)</span>
              <div class="tooltip">
                <button
                  type="button"
                  class="tooltip__trigger"
                  aria-label="Подсказка: оставьте конечную дату пустой, если указана одна дата"
                  aria-expanded="false"
                >
                  ?
                </button>
                <div class="tooltip__bubble" role="tooltip">Оставьте конечную дату пустой, если указана одна дата.</div>
              </div>
            </div>
            <div class="date-range">
              <input type="date" class="joint-events-date__start" aria-label="Дата начала" />
              <span class="date-range__dash">—</span>
              <input type="date" class="joint-events-date__end" aria-label="Дата окончания" />
            </div>
          </div>
          <label class="field field--compact">
            <span class="field__label">Мероприятия</span>
            <textarea name="joint_event_description" placeholder="Например, участие в двух выставках"></textarea>
          </label>
        </div>
        <button type="button" class="multi-input__remove joint-events__row-remove" aria-label="Удалить запись">&times;</button>
      `;

      const listContainer = row.querySelector('[data-list="groups"]');
      const addButton = row.querySelector('.joint-events__add-item[data-target="groups"]');

      if (listContainer && addButton) {
        setupRowList({ row, target: 'groups', placeholder: 'Например, 4102', startEmpty: false });
      }

      const removeButton = row.querySelector('.joint-events__row-remove');

      if (removeButton) {
        if (!isRemovable) {
          removeButton.disabled = true;
          removeButton.setAttribute('aria-disabled', 'true');
        } else {
          removeButton.addEventListener('click', () => row.remove());
        }
      }

      return row;
    }

    function createExtracurricularRow({ isRemovable = true } = {}) {
      const row = document.createElement('div');
      row.className = 'curator-hours__row extracurricular-row';

      row.innerHTML = `
        <div class="curator-hours__grid">
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Дата (дата или период)</span>
              <div class="tooltip">
                <button
                  type="button"
                  class="tooltip__trigger"
                  aria-label="Подсказка: оставьте конечную дату пустой, если указана одна дата"
                  aria-expanded="false"
                >
                  ?
                </button>
                <div class="tooltip__bubble" role="tooltip">Оставьте конечную дату пустой, если указана одна дата.</div>
              </div>
            </div>
            <div class="date-range">
              <input type="date" class="extracurricular-date__start" aria-label="Дата начала" />
              <span class="date-range__dash">—</span>
              <input type="date" class="extracurricular-date__end" aria-label="Дата окончания" />
            </div>
          </div>
          <label class="field field--compact">
            <span class="field__label">Мероприятие</span>
            <textarea class="extracurricular-event__description" placeholder="Например, участие в форуме наставников" rows="3"></textarea>
          </label>
        </div>
        <div class="curator-hours__row-actions">
          <button type="button" class="multi-input__remove extracurricular-row__remove" aria-label="Удалить строку">×</button>
        </div>
      `;

      const removeButton = row.querySelector('.extracurricular-row__remove');

      if (removeButton) {
        if (!isRemovable) {
          removeButton.disabled = true;
          removeButton.setAttribute('aria-disabled', 'true');
          removeButton.dataset.fixed = 'true';
        } else {
          removeButton.addEventListener('click', () => row.remove());
        }
      }

      return row;
    }

    function updateExtracurricularRowRemovalState() {
      const rows = extracurricularRowsContainer.querySelectorAll('.extracurricular-row');
      rows.forEach((row) => {
        const removeButton = row.querySelector('.extracurricular-row__remove');
        if (!removeButton) return;
        if (removeButton.dataset.fixed === 'true') {
          removeButton.disabled = true;
          return;
        }
        removeButton.disabled = rows.length === 1;
      });
    }

    function addExtracurricularRow(options = {}) {
      const row = createExtracurricularRow(options);
      const removeButton = row.querySelector('.extracurricular-row__remove');

      if (removeButton && !removeButton.dataset.fixed) {
        removeButton.addEventListener('click', () => {
          if (extracurricularRowsContainer.querySelectorAll('.extracurricular-row').length === 1) return;
          row.remove();
          updateExtracurricularRowRemovalState();
        });
      }

      extracurricularRowsContainer.append(row);
      setupTooltips();
      updateExtracurricularRowRemovalState();
    }

    function createPersonalProgramRow() {
      const row = document.createElement('div');
      row.className = 'curator-hours__row personal-program-row';

      row.innerHTML = `
        <div class="curator-hours__grid">
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Дата (дата или период)</span>
              <div class="tooltip">
                <button
                  type="button"
                  class="tooltip__trigger"
                  aria-label="Подсказка: оставьте конечную дату пустой, если указана одна дата"
                  aria-expanded="false"
                >
                  ?
                </button>
                <div class="tooltip__bubble" role="tooltip">Оставьте конечную дату пустой, если указана одна дата.</div>
              </div>
            </div>
            <div class="date-range">
              <input type="date" class="personal-program-date__start" aria-label="Дата начала" />
              <span class="date-range__dash">—</span>
              <input type="date" class="personal-program-date__end" aria-label="Дата окончания" />
            </div>
          </div>
          <label class="field field--compact">
            <span class="field__label">Мероприятие</span>
            <textarea class="personal-program-event__description" placeholder="Например, участие в форуме «Голос поколения»" rows="3"></textarea>
          </label>
        </div>
        <div class="curator-hours__row-actions">
          <button type="button" class="multi-input__remove personal-program-row__remove" aria-label="Удалить строку">×</button>
        </div>
      `;

      const removeButton = row.querySelector('.personal-program-row__remove');
      if (removeButton) {
        removeButton.addEventListener('click', () => row.remove());
      }

      return row;
    }

    function addPersonalProgramRow() {
      const row = createPersonalProgramRow();
      personalProgramRowsContainer.append(row);
      setupTooltips();
    }

    function createScientificWorkRow() {
      const row = document.createElement('div');
      row.className = 'curator-hours__row scientific-work-row';

      row.innerHTML = `
        <div class="curator-hours__grid">
          <label class="field field--compact">
            <span class="field__label">Вводные данные</span>
            <textarea class="scientific-work__description" placeholder="Например, монография или статья с указанием издания и соавторов" rows="3"></textarea>
          </label>
          <label class="field field--compact">
            <span class="field__label">Ссылка на интернет-ресурс</span>
            <input type="url" class="scientific-work__link" placeholder="https://example.com" />
          </label>
        </div>
        <div class="curator-hours__row-actions">
          <button type="button" class="multi-input__remove scientific-work-row__remove" aria-label="Удалить строку">×</button>
        </div>
      `;

      const removeButton = row.querySelector('.scientific-work-row__remove');
      if (removeButton) {
        removeButton.addEventListener('click', () => row.remove());
      }

      return row;
    }

    function addScientificWorkRow() {
      const row = createScientificWorkRow();
      scientificWorkRowsContainer.append(row);
    }

    function createInterviewRow() {
      const row = document.createElement('div');
      row.className = 'curator-hours__row interview-row';

      row.innerHTML = `
        <div class="curator-hours__grid">
          <label class="field field--compact">
            <span class="field__label">Ссылка на интернет-ресурс</span>
            <input type="url" class="interview__link" placeholder="https://example.com/material" />
          </label>
        </div>
        <div class="curator-hours__row-actions">
          <button type="button" class="multi-input__remove interview-row__remove" aria-label="Удалить строку">×</button>
        </div>
      `;

      const removeButton = row.querySelector('.interview-row__remove');
      if (removeButton) {
        removeButton.addEventListener('click', () => row.remove());
      }

      return row;
    }

    function addInterviewRow() {
      const row = createInterviewRow();
      interviewRowsContainer.append(row);
    }

    function createQualificationCourseRow() {
      const row = document.createElement('div');
      row.className = 'curator-hours__row qualification-course-row';

      row.innerHTML = `
        <div class="curator-hours__grid">
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Дата (Дата или период)</span>
              <div class="tooltip">
                <button
                  type="button"
                  class="tooltip__trigger"
                  aria-label="Подсказка: оставьте конечную дату пустой, если указана одна дата"
                  aria-expanded="false"
                >
                  ?
                </button>
                <div class="tooltip__bubble" role="tooltip">Оставьте конечную дату пустой, если указана одна дата.</div>
              </div>
            </div>
            <div class="date-range">
              <input type="date" class="qualification-course-date__start" aria-label="Дата начала" />
              <span class="date-range__dash">—</span>
              <input type="date" class="qualification-course-date__end" aria-label="Дата окончания" />
            </div>
          </div>
          <label class="field field--compact">
            <span class="field__label">Мероприятие</span>
            <textarea class="qualification-course__description" placeholder="Например, курс повышения квалификации по молодежной политике" rows="3"></textarea>
          </label>
        </div>
        <div class="curator-hours__row-actions">
          <button type="button" class="multi-input__remove qualification-course-row__remove" aria-label="Удалить строку">×</button>
        </div>
      `;

      const removeButton = row.querySelector('.qualification-course-row__remove');
      if (removeButton) {
        removeButton.addEventListener('click', () => row.remove());
      }

      return row;
    }

    function addQualificationCourseRow() {
      const row = createQualificationCourseRow();
      qualificationCourseRowsContainer.append(row);
      setupTooltips();
    }

    let tooltipListenersAttached = false;

    function updateTooltipPosition(tooltip) {
      const bubble = tooltip.querySelector('.tooltip__bubble');

      if (!bubble) return;

      bubble.style.setProperty('--tooltip-shift', '0px');

      const rect = bubble.getBoundingClientRect();
      const padding = 12;
      const overflowLeft = padding - rect.left;
      const overflowRight = rect.right - (window.innerWidth - padding);
      let shift = 0;

      if (overflowLeft > 0) {
        shift += overflowLeft;
      }

      if (overflowRight > 0) {
        shift -= overflowRight;
      }

      if (shift !== 0) {
        bubble.style.setProperty('--tooltip-shift', `${shift}px`);
      }
    }

    function setupTooltips() {
      const triggers = document.querySelectorAll('.tooltip__trigger');

      triggers.forEach((trigger) => {
        if (trigger.dataset.tooltipReady) return;

        const tooltip = trigger.closest('.tooltip');
        if (!tooltip) return;

        trigger.dataset.tooltipReady = 'true';

        const openAndUpdate = () => {
          if (tooltip.classList.contains('tooltip--active')) return;

          closeAllTooltips(tooltip);
          tooltip.classList.add('tooltip--active');
          trigger.setAttribute('aria-expanded', 'true');
          requestAnimationFrame(() => updateTooltipPosition(tooltip));
        };

        trigger.addEventListener('click', (event) => {
          event.stopPropagation();
          const isActive = tooltip.classList.toggle('tooltip--active');
          trigger.setAttribute('aria-expanded', String(isActive));

          if (isActive) {
            closeAllTooltips(tooltip);
            requestAnimationFrame(() => updateTooltipPosition(tooltip));
          }
        });

        trigger.addEventListener('mouseenter', openAndUpdate);
        trigger.addEventListener('focus', openAndUpdate);

        trigger.addEventListener('blur', () => {
          setTimeout(() => {
            if (!tooltip.contains(document.activeElement)) {
              tooltip.classList.remove('tooltip--active');
              trigger.setAttribute('aria-expanded', 'false');
            }
          }, 120);
        });
      });

      if (!tooltipListenersAttached) {
        tooltipListenersAttached = true;

        document.addEventListener('click', (event) => {
          if (event.target.closest('.tooltip')) return;
          closeAllTooltips();
        });

        window.addEventListener('resize', () => {
          requestAnimationFrame(() => {
            document.querySelectorAll('.tooltip.tooltip--active').forEach(updateTooltipPosition);
          });
        });
      }
    }

    function createRow(inputName, placeholder = '') {
      const row = document.createElement('div');
      row.className = 'multi-input__row';

      const input = document.createElement('input');
      input.type = 'text';
      input.name = inputName;
      input.required = true;
      input.placeholder = placeholder;

      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'multi-input__remove';
      removeButton.setAttribute('aria-label', 'Удалить запись');
      removeButton.textContent = '×';

      row.append(input, removeButton);
      return row;
    }

    function setupMultiInput({ name, inputName, placeholder = '' }) {
      const container = form.querySelector(`[data-name="${name}"]`);
      const addButton = form.querySelector(`[data-add="${name}"]`);

      if (!container || !addButton) return;

      function updateRemoveState() {
        const rows = container.querySelectorAll('.multi-input__row');
        rows.forEach((row) => {
          const removeButton = row.querySelector('.multi-input__remove');
          if (!removeButton) return;
          const isDisabled = rows.length === 1;
          removeButton.disabled = isDisabled;
        });
      }

      function attachRemove(row) {
        const removeButton = row.querySelector('.multi-input__remove');
        if (!removeButton) return;
        removeButton.addEventListener('click', () => {
          if (container.querySelectorAll('.multi-input__row').length === 1) return;
          row.remove();
          updateRemoveState();
        });
      }

      container.querySelectorAll('.multi-input__row').forEach((row) => attachRemove(row));

      addButton.addEventListener('click', () => {
        const newRow = createRow(inputName, placeholder);
        attachRemove(newRow);
        container.append(newRow);
        updateRemoveState();
      });

      updateRemoveState();
    }

    function collectFaculties() {
      return Array.from(form.querySelectorAll('input[name="institute_or_faculty"]:checked')).map((input) => input.value);
    }

    function getBooleanRadio(name) {
      const selected = form.querySelector(`input[name="${name}"]:checked`);
      if (!selected) return null;
      return selected.value === 'true';
    }

    function getSelectedRadio(name) {
      const selected = form.querySelector(`input[name="${name}"]:checked`);
      return selected ? selected.value : '';
    }

    function sanitizeText(value = '') {
      return value.replace(/\s*\n\s*/g, ' ').trim();
    }

    function getValue(name) {
      return sanitizeText(form.elements[name]?.value || '');
    }

    function collectList(name) {
      const container = form.querySelector(`[data-name="${name}"]`);
      if (!container) return [];
      return Array.from(container.querySelectorAll('input'))
        .map((input) => sanitizeText(input.value))
        .filter(Boolean);
    }

    function createListRow(placeholder = '') {
      const row = document.createElement('div');
      row.className = 'multi-input__row';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = placeholder;

      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'multi-input__remove';
      removeButton.setAttribute('aria-label', 'Удалить запись');
      removeButton.textContent = '×';

      row.append(input, removeButton);
      return row;
    }

    function setRadioValue(name, value) {
      const inputs = form.querySelectorAll(`input[name="${name}"]`);
      if (!inputs.length) return;

      if (value === null || value === undefined) {
        inputs.forEach((input) => {
          input.checked = false;
        });
        return;
      }

      const normalized = typeof value === 'boolean' ? String(value) : value;
      const target = form.querySelector(`input[name="${name}"][value="${normalized}"]`);

      inputs.forEach((input) => {
        input.checked = input === target;
      });

      if (target) {
        target.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }

    function fillMultiInput(name, values = []) {
      const container = form.querySelector(`[data-name="${name}"]`);
      const addButton = form.querySelector(`[data-add="${name}"]`);

      if (!container) return;

      const desiredLength = Math.max(values.length, 1);
      while (container.querySelectorAll('.multi-input__row').length < desiredLength) {
        addButton?.click();
      }

      const inputs = container.querySelectorAll('input');
      inputs.forEach((input, index) => {
        input.value = values[index] ?? '';
      });

      const removeButtons = container.querySelectorAll('.multi-input__remove');
      const cutoff = values.length ? values.length : 1;

      for (let i = removeButtons.length - 1; i >= cutoff; i -= 1) {
        const removeButton = removeButtons[i];
        if (removeButton && !removeButton.disabled) {
          removeButton.click();
        }
      }
    }

    function setRowList(row, target, values = []) {
      const listContainer = row.querySelector(`[data-list="${target}"]`);
      const addButton = row.querySelector(`[data-target="${target}"]`);

      if (!listContainer || !addButton) return;

      const desiredLength = Math.max(values.length, 1);
      while (listContainer.querySelectorAll('.multi-input__row').length < desiredLength) {
        addButton.click();
      }

      const inputs = listContainer.querySelectorAll('input');
      inputs.forEach((input, index) => {
        input.value = values[index] ?? '';
      });

      const removeButtons = listContainer.querySelectorAll('.multi-input__remove');
      const cutoff = values.length ? values.length : 1;

      for (let i = removeButtons.length - 1; i >= cutoff; i -= 1) {
        const removeButton = removeButtons[i];
        if (removeButton && !removeButton.disabled) {
          removeButton.click();
        }
      }
    }

    function setupRowList({ row, target, placeholder = '', startEmpty = false }) {
      const listContainer = row.querySelector(`[data-list="${target}"]`);
      const addButton = row.querySelector(`.curator-hours__add-item[data-target="${target}"]`);

      if (!listContainer || !addButton) return;

      function updateRemoveState() {
        const rows = listContainer.querySelectorAll('.multi-input__row');
        rows.forEach((currentRow) => {
          const removeButton = currentRow.querySelector('.multi-input__remove');
          if (!removeButton) return;
          removeButton.disabled = rows.length === 1;
        });
      }

      function attachRemove(listRow) {
        const removeButton = listRow.querySelector('.multi-input__remove');
        if (!removeButton) return;
        removeButton.addEventListener('click', () => {
          if (listContainer.querySelectorAll('.multi-input__row').length === 1) return;
          listRow.remove();
          updateRemoveState();
        });
      }

      if (!startEmpty) {
        const firstRow = createListRow(placeholder);
        attachRemove(firstRow);
        listContainer.append(firstRow);
        updateRemoveState();
      }

      addButton.addEventListener('click', () => {
        const newRow = createListRow(placeholder);
        attachRemove(newRow);
        listContainer.append(newRow);
        updateRemoveState();
      });
    }

    function createDirectionChip(value, container) {
      if (!value || container.querySelector(`[data-direction-value="${value}"]`)) return;
      const chip = document.createElement('span');
      chip.className = 'pill pill--compact';
      chip.dataset.directionValue = value;
      chip.textContent = value;

      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'pill__remove';
      removeButton.setAttribute('aria-label', 'Удалить направление');
      removeButton.textContent = '×';
      removeButton.addEventListener('click', () => chip.remove());

      chip.append(removeButton);
      container.append(chip);
    }

    function setupDirections(row) {
      const select = row.querySelector('.curator-hours__direction-input');
      const addButton = row.querySelector('.curator-hours__add-direction');
      const listContainer = row.querySelector('[data-list="directions"]');

      if (!select || !addButton || !listContainer) return;

      directionsOptions.forEach((option) => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.append(opt);
      });

      addButton.addEventListener('click', () => {
        createDirectionChip(select.value, listContainer);
      });
    }

    function collectDirections(container) {
      if (!container) return [];
      return Array.from(container.querySelectorAll('[data-direction-value]')).map((chip) => chip.dataset.directionValue);
    }

    function setDirections(row, directions = []) {
      const listContainer = row.querySelector('[data-list="directions"]');
      if (!listContainer) return;

      listContainer.innerHTML = '';
      directions.forEach((direction) => {
        createDirectionChip(direction, listContainer);
      });
    }

    function collectDynamicList(container) {
      if (!container) return [];
      return Array.from(container.querySelectorAll('input'))
        .map((input) => sanitizeText(input.value))
        .filter(Boolean);
    }

    function splitRange(rangeText = '') {
      const [start = '', end = ''] = rangeText.split(/\s*[–-]\s*/);
      return { start, end };
    }

    function setManualReportingPeriod({ label = '', dateStart = '', dateEnd = '', deadline = '' } = {}) {
      if (reportingPeriodLabelInput) reportingPeriodLabelInput.value = label;
      if (reportingPeriodStartInput) reportingPeriodStartInput.value = dateStart;
      if (reportingPeriodEndInput) reportingPeriodEndInput.value = dateEnd;
      if (reportingPeriodDeadlineInput) reportingPeriodDeadlineInput.value = deadline;
    }

    function getManualReportingPeriod() {
      const label = sanitizeText(reportingPeriodLabelInput?.value || '');
      const dateStart = reportingPeriodStartInput?.value || '';
      const dateEnd = reportingPeriodEndInput?.value || '';
      const deadline = reportingPeriodDeadlineInput?.value || '';

      return {
        label,
        date_start: dateStart,
        date_end: dateEnd,
        deadline,
        display: buildReportingPeriodDisplay({ label, dateStart, dateEnd, deadline }),
      };
    }

    function updateManualPeriodFromSelect() {
      if (!reportingPeriodSelect) return;

      const selectedOption = reportingPeriodSelect.options[reportingPeriodSelect.selectedIndex];
      if (!selectedOption) return;

      const { label, dateStart, dateEnd, deadline } = selectedOption.dataset;
      setManualReportingPeriod({
        label: label || '',
        dateStart: dateStart || '',
        dateEnd: dateEnd || '',
        deadline: deadline || '',
      });
    }

    function buildReportingPeriodDisplay({ label, dateStart, dateEnd, deadline }) {
      const range = formatDateRange(dateStart, dateEnd);
      const hasRange = range && range !== '—';

      if (label && hasRange) {
        return `${label}: ${range}${deadline ? ` (Прислать отчёт до ${deadline})` : ''}`;
      }

      if (hasRange) {
        return `${range}${deadline ? ` (Прислать отчёт до ${deadline})` : ''}`;
      }

      return deadline || '';
    }

    function collectReportingPeriod() {
      if (!reportingPeriodSelect) return {};

      const selectedOption = reportingPeriodSelect.options[reportingPeriodSelect.selectedIndex];

      if (!selectedOption) return {};

      const manualPeriod = getManualReportingPeriod();
      const { dataset, textContent } = selectedOption;
      const { start, end } = splitRange(dataset.range);

      const label = manualPeriod.label || dataset.label || '';
      const dateStart = manualPeriod.date_start || dataset.dateStart || start || '';
      const dateEnd = manualPeriod.date_end || dataset.dateEnd || end || '';
      const deadline = manualPeriod.deadline || dataset.deadline || '';
      const display =
        manualPeriod.display || buildReportingPeriodDisplay({ label, dateStart, dateEnd, deadline }) || textContent || '';

      return {
        label,
        date_start: dateStart,
        date_end: dateEnd,
        deadline,
        display,
      };
    }

    function createCuratorHoursRow({ isRemovable = true } = {}) {
      const row = document.createElement('div');
      row.className = 'curator-hours__row';
      row.innerHTML = `
        <div class="curator-hours__grid">
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Группы</span>
              <button type="button" class="chip chip--interactive curator-hours__add-item" data-target="groups">Добавить</button>
            </div>
            <div class="multi-input" data-list="groups"></div>
          </div>
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Дата или период</span>
              <div class="tooltip">
                <button
                  type="button"
                  class="tooltip__trigger"
                  aria-label="Подсказка: оставьте конечную дату пустой, если указана одна дата"
                  aria-expanded="false"
                >
                  ?
                </button>
                <div class="tooltip__bubble" role="tooltip">Оставьте конечную дату пустой, если указана одна дата.</div>
              </div>
            </div>
            <div class="date-range">
              <input type="date" class="date-range__start" aria-label="Дата начала" />
              <span class="date-range__dash">—</span>
              <input type="date" class="date-range__end" aria-label="Дата окончания" />
            </div>
          </div>
          <label class="field field--compact">
            <span class="field__label">Тема</span>
            <textarea class="curator-hours__topic" placeholder="Например, профилактическая беседа" rows="3"></textarea>
          </label>
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Направленность</span>
              <div class="field__meta">
                <div class="tooltip">
                  <button
                    type="button"
                    class="tooltip__trigger"
                    aria-label="Подсказка: выберите направление и нажмите плюс, чтобы добавить его"
                    aria-expanded="false"
                  >
                    ?
                  </button>
                  <div class="tooltip__bubble" role="tooltip">Выберите направление в списке ниже и нажмите «+», чтобы добавить его. Можно указать несколько направлений; для удаления используйте крестик на метке.</div>
                </div>
                <button type="button" class="chip chip--interactive curator-hours__add-direction">+</button>
              </div>
            </div>
            <div class="curator-hours__direction-select">
              <select class="curator-hours__direction-input"></select>
            </div>
            <div class="pill-list" data-list="directions"></div>
          </div>
          <div class="field field--compact">
            <div class="field__label-row">
              <span class="field__label">Приглашённые специалисты</span>
              <button type="button" class="chip chip--interactive curator-hours__add-item" data-target="specialists">Добавить</button>
            </div>
            <div class="multi-input" data-list="specialists"></div>
          </div>
        </div>
        <div class="curator-hours__row-actions">
          <button type="button" class="multi-input__remove curator-hours__remove-row" aria-label="Удалить строку">×</button>
        </div>
      `;

      setupRowList({ row, target: 'groups', placeholder: 'Например, 1234' });
      setupRowList({
        row,
        target: 'specialists',
        placeholder: 'Например, приглашённый специалист',
        startEmpty: true,
      });
      setupDirections(row);

      const removeButton = row.querySelector('.curator-hours__remove-row');

      if (removeButton && !isRemovable) {
        removeButton.disabled = true;
        removeButton.setAttribute('aria-disabled', 'true');
        removeButton.dataset.fixed = 'true';
      }

      return row;
    }

    function updateRowRemovalState() {
      const rows = curatorHoursRows.querySelectorAll('.curator-hours__row');
      rows.forEach((row) => {
        const removeButton = row.querySelector('.curator-hours__remove-row');
        if (!removeButton) return;
        if (removeButton.dataset.fixed === 'true') {
          removeButton.disabled = true;
          return;
        }
        removeButton.disabled = rows.length === 1;
      });
    }

    function addCuratorHourRow(options = {}) {
      const row = createCuratorHoursRow(options);
      const removeButton = row.querySelector('.curator-hours__remove-row');

      if (removeButton) {
        if (removeButton.dataset.fixed === 'true') {
          removeButton.disabled = true;
        } else {
          removeButton.addEventListener('click', () => {
            if (curatorHoursRows.querySelectorAll('.curator-hours__row').length === 1) return;
            row.remove();
            updateRowRemovalState();
          });
        }
      }

      curatorHoursRows.append(row);
      setupTooltips();
      updateRowRemovalState();
    }

    function collectCuratorHoursRows() {
      return Array.from(curatorHoursRows.querySelectorAll('.curator-hours__row'))
        .map((row) => {
          const groups = collectDynamicList(row.querySelector('[data-list="groups"]'));
          const specialists = collectDynamicList(row.querySelector('[data-list="specialists"]'));
          const dateStart = row.querySelector('.date-range__start')?.value || '';
          const dateEnd = row.querySelector('.date-range__end')?.value || '';
          const topic = sanitizeText(row.querySelector('.curator-hours__topic')?.value || '');
          const directions = collectDirections(row.querySelector('[data-list="directions"]'));

          if (!groups.length && !specialists.length && !dateStart && !dateEnd && !topic && !directions.length) {
            return null;
          }

          return { groups, date_start: dateStart, date_end: dateEnd, topic, directions, specialists };
        })
        .filter(Boolean);
    }

    function fillCuratorHoursRows(rows = []) {
      curatorHoursRows.innerHTML = '';

      rows.forEach((item) => {
        addCuratorHourRow();
        const row = curatorHoursRows.lastElementChild;

        if (!row) return;

        setRowList(row, 'groups', item.groups || []);
        setRowList(row, 'specialists', item.specialists || []);
        row.querySelector('.date-range__start').value = item.date_start || '';
        row.querySelector('.date-range__end').value = item.date_end || '';
        const topicField = row.querySelector('.curator-hours__topic');
        if (topicField) topicField.value = item.topic || '';
        setDirections(row, item.directions || []);
      });

      updateRowRemovalState();
      setupTooltips();
    }

    function collectAchievements() {
      return Array.from(achievementRowsContainer.querySelectorAll('.achievement-row'))
        .map((row) => {
          const dateStart = row.querySelector('.achievement-date__start')?.value || '';
          const dateEnd = row.querySelector('.achievement-date__end')?.value || '';
          const event = sanitizeText(row.querySelector('textarea[name="achievement_event"]')?.value || '');
          const group = sanitizeText(row.querySelector('input[name="achievement_group"]')?.value || '');
          const student = sanitizeText(row.querySelector('input[name="achievement_student"]')?.value || '');
          const result = sanitizeText(row.querySelector('textarea[name="achievement_result"]')?.value || '');

          if (!dateStart && !dateEnd && !event && !group && !student && !result) {
            return null;
          }

          return { date_start: dateStart, date_end: dateEnd, event, group, student, result };
        })
        .filter(Boolean);
    }

    function fillAchievementRows(rows = []) {
      achievementRowsContainer.innerHTML = '';

      rows.forEach((item) => {
        const row = createAchievementRow();
        row.querySelector('.achievement-date__start').value = item.date_start || '';
        row.querySelector('.achievement-date__end').value = item.date_end || '';
        row.querySelector('textarea[name="achievement_event"]').value = item.event || '';
        row.querySelector('input[name="achievement_group"]').value = item.group || '';
        row.querySelector('input[name="achievement_student"]').value = item.student || '';
        row.querySelector('textarea[name="achievement_result"]').value = item.result || '';
        achievementRowsContainer.append(row);
      });

      setupTooltips();
    }

    function collectMentorSupportRows() {
      if (!mentorSupportRowsContainer || mentorSupportRowsContainer.children.length === 0) return [];

      return Array.from(mentorSupportRowsContainer.querySelectorAll('.achievement-row'))
        .map((row) => {
          const dateStart = row.querySelector('.mentor-support-date__start')?.value || '';
          const dateEnd = row.querySelector('.mentor-support-date__end')?.value || '';
          const event = sanitizeText(row.querySelector('textarea[name="mentor_support_event"]')?.value || '');
          const group = sanitizeText(row.querySelector('input[name="mentor_support_group"]')?.value || '');
          const student = sanitizeText(row.querySelector('input[name="mentor_support_student"]')?.value || '');
          const result = sanitizeText(row.querySelector('textarea[name="mentor_support_result"]')?.value || '');

          if (!dateStart && !dateEnd && !event && !group && !student && !result) {
            return null;
          }

          return { date_start: dateStart, date_end: dateEnd, event, group, student, result };
        })
        .filter(Boolean);
    }

    function fillMentorSupportRows(rows = []) {
      if (!mentorSupportRowsContainer) return;

      mentorSupportRowsContainer.innerHTML = '';

      rows.forEach((item) => {
        const row = createMentorSupportRow();
        row.querySelector('.mentor-support-date__start').value = item.date_start || '';
        row.querySelector('.mentor-support-date__end').value = item.date_end || '';
        row.querySelector('textarea[name="mentor_support_event"]').value = item.event || '';
        row.querySelector('input[name="mentor_support_group"]').value = item.group || '';
        row.querySelector('input[name="mentor_support_student"]').value = item.student || '';
        row.querySelector('textarea[name="mentor_support_result"]').value = item.result || '';
        mentorSupportRowsContainer.append(row);
      });

      setupTooltips();
    }

    function collectJointEvents() {
      if (!jointEventsDetails || jointEventRowsContainer.children.length === 0) return [];

      return Array.from(jointEventRowsContainer.querySelectorAll('.joint-events__row'))
        .map((row) => {
          const groups = collectDynamicList(row.querySelector('[data-list="groups"]'));
          const dateStart = row.querySelector('.joint-events-date__start')?.value || '';
          const dateEnd = row.querySelector('.joint-events-date__end')?.value || '';
          const event = sanitizeText(row.querySelector('textarea[name="joint_event_description"]')?.value || '');

          if (!groups.length && !dateStart && !dateEnd && !event) {
            return null;
          }

          return { groups, date_start: dateStart, date_end: dateEnd, event };
        })
        .filter(Boolean);
    }

    function fillJointEventsRows(rows = []) {
      jointEventRowsContainer.innerHTML = '';

      rows.forEach((item) => {
        const row = createJointEventRow();
        setRowList(row, 'groups', item.groups || []);
        row.querySelector('.joint-events-date__start').value = item.date_start || '';
        row.querySelector('.joint-events-date__end').value = item.date_end || '';
        const description = row.querySelector('textarea[name="joint_event_description"]');
        if (description) description.value = item.event || '';
        jointEventRowsContainer.append(row);
      });

      setupTooltips();
    }

    function collectExtracurricularRows() {
      if (!extracurricularDetails || extracurricularRowsContainer.children.length === 0) return [];

      return Array.from(extracurricularRowsContainer.querySelectorAll('.extracurricular-row'))
        .map((row) => {
          const dateStart = row.querySelector('.extracurricular-date__start')?.value || '';
          const dateEnd = row.querySelector('.extracurricular-date__end')?.value || '';
          const event = sanitizeText(row.querySelector('.extracurricular-event__description')?.value || '');

          if (!dateStart && !dateEnd && !event) {
            return null;
          }

          return { date_start: dateStart, date_end: dateEnd, event };
        })
        .filter(Boolean);
    }

    function fillExtracurricularRows(rows = []) {
      extracurricularRowsContainer.innerHTML = '';

      rows.forEach((item) => {
        addExtracurricularRow();
        const row = extracurricularRowsContainer.lastElementChild;

        if (!row) return;

        row.querySelector('.extracurricular-date__start').value = item.date_start || '';
        row.querySelector('.extracurricular-date__end').value = item.date_end || '';
        const description = row.querySelector('.extracurricular-event__description');
        if (description) description.value = item.event || '';
      });

      updateExtracurricularRowRemovalState();
      setupTooltips();
    }

    function collectPersonalProgramRows() {
      if (!personalProgramRowsContainer || personalProgramRowsContainer.children.length === 0) return [];

      return Array.from(personalProgramRowsContainer.querySelectorAll('.personal-program-row'))
        .map((row) => {
          const dateStart = row.querySelector('.personal-program-date__start')?.value || '';
          const dateEnd = row.querySelector('.personal-program-date__end')?.value || '';
          const event = sanitizeText(row.querySelector('.personal-program-event__description')?.value || '');

          if (!dateStart && !dateEnd && !event) {
            return null;
          }

          return { date_start: dateStart, date_end: dateEnd, event };
        })
        .filter(Boolean);
    }

    function fillPersonalProgramRows(rows = []) {
      if (!personalProgramRowsContainer) return;

      personalProgramRowsContainer.innerHTML = '';

      rows.forEach((item) => {
        addPersonalProgramRow();
        const row = personalProgramRowsContainer.lastElementChild;

        if (!row) return;

        row.querySelector('.personal-program-date__start').value = item.date_start || '';
        row.querySelector('.personal-program-date__end').value = item.date_end || '';
        const description = row.querySelector('.personal-program-event__description');
        if (description) description.value = item.event || '';
      });

      setupTooltips();
    }

    function collectScientificWorks() {
      if (!scientificWorkRowsContainer || scientificWorkRowsContainer.children.length === 0) return [];

      return Array.from(scientificWorkRowsContainer.querySelectorAll('.scientific-work-row'))
        .map((row) => {
          const description = sanitizeText(row.querySelector('.scientific-work__description')?.value || '');
          const link = sanitizeText(row.querySelector('.scientific-work__link')?.value || '');

          if (!description && !link) {
            return null;
          }

          return { description, link };
        })
        .filter(Boolean);
    }

    function fillScientificWorks(rows = []) {
      if (!scientificWorkRowsContainer) return;

      scientificWorkRowsContainer.innerHTML = '';

      rows.forEach((item) => {
        addScientificWorkRow();
        const row = scientificWorkRowsContainer.lastElementChild;

        if (!row) return;

        const description = row.querySelector('.scientific-work__description');
        const link = row.querySelector('.scientific-work__link');
        if (description) description.value = item.description || '';
        if (link) link.value = item.link || '';
      });
    }

    function collectInterviews() {
      if (!interviewRowsContainer || interviewRowsContainer.children.length === 0) return [];

      return Array.from(interviewRowsContainer.querySelectorAll('.interview-row'))
        .map((row) => {
          const link = sanitizeText(row.querySelector('.interview__link')?.value || '');

          if (!link) {
            return null;
          }

          return { link };
        })
        .filter(Boolean);
    }

    function fillInterviews(rows = []) {
      if (!interviewRowsContainer) return;

      interviewRowsContainer.innerHTML = '';

      rows.forEach((item) => {
        addInterviewRow();
        const row = interviewRowsContainer.lastElementChild;

        if (!row) return;

        const link = row.querySelector('.interview__link');
        if (link) link.value = item.link || '';
      });
    }

    function collectQualificationCourses() {
      if (!qualificationCourseRowsContainer || qualificationCourseRowsContainer.children.length === 0) return [];

      return Array.from(qualificationCourseRowsContainer.querySelectorAll('.qualification-course-row'))
        .map((row) => {
          const dateStart = row.querySelector('.qualification-course-date__start')?.value || '';
          const dateEnd = row.querySelector('.qualification-course-date__end')?.value || '';
          const event = sanitizeText(row.querySelector('.qualification-course__description')?.value || '');

          if (!dateStart && !dateEnd && !event) {
            return null;
          }

          return { date_start: dateStart, date_end: dateEnd, event };
        })
        .filter(Boolean);
    }

    function fillQualificationCourses(rows = []) {
      if (!qualificationCourseRowsContainer) return;

      qualificationCourseRowsContainer.innerHTML = '';

      rows.forEach((item) => {
        addQualificationCourseRow();
        const row = qualificationCourseRowsContainer.lastElementChild;

        if (!row) return;

        row.querySelector('.qualification-course-date__start').value = item.date_start || '';
        row.querySelector('.qualification-course-date__end').value = item.date_end || '';
        const description = row.querySelector('.qualification-course__description');
        if (description) description.value = item.event || '';
      });

      setupTooltips();
    }

    function toggleCuratorHoursDetails() {
      const isHeld = getBooleanRadio('held_minimum_three_curator_sessions_in_reporting_period');
      curatorHoursDetails.hidden = !isHeld;

      if (isHeld && !curatorHoursRows.children.length) {
        Array.from({ length: 3 }).forEach(() => addCuratorHourRow({ isRemovable: false }));
      }
    }

    function toggleJointActivitiesDetails() {
      const isInforming = getBooleanRadio('inform_group_about_events');
      jointActivitiesDetails.hidden = !isInforming;

      if (!isInforming) {
        achievementRowsContainer.innerHTML = '';
        jointEventsDetails.hidden = true;
        jointEventRowsContainer.innerHTML = '';
        form
          .querySelectorAll(
            'input[name="manages_group_chat"], input[name="participated_in_two_events_with_group"]'
          )
          .forEach((input) => {
            input.checked = false;
          });
      }
    }

    function toggleJointParticipationDetails() {
      const isParticipating = getBooleanRadio('participated_in_two_events_with_group');
      jointEventsDetails.hidden = !isParticipating;

      if (!isParticipating) {
        jointEventRowsContainer.innerHTML = '';
        return;
      }

      if (!jointEventRowsContainer.children.length) {
        Array.from({ length: 2 }).forEach(() => {
          jointEventRowsContainer.append(createJointEventRow({ isRemovable: false }));
        });
      }
    }

    function toggleExtracurricularDetails() {
      const isParticipating = getBooleanRadio('participated_in_two_curator_events');
      extracurricularDetails.hidden = !isParticipating;

      if (!isParticipating) {
        extracurricularRowsContainer.innerHTML = '';
        return;
      }

      if (!extracurricularRowsContainer.children.length) {
        Array.from({ length: 2 }).forEach(() => {
          addExtracurricularRow({ isRemovable: false });
        });
      }
    }

    function buildReportData() {
      const heldMinimumThreeCuratorSessions = getBooleanRadio('held_minimum_three_curator_sessions_in_reporting_period');
      const participatedInCuratorEvents = getBooleanRadio('participated_in_two_curator_events');
      return {
        _comments: fieldComments,
        reporting_period: collectReportingPeriod(),
        full_name: getValue('full_name'),
        job_positions: collectList('job_positions'),
        department: getValue('department'),
        contact_phone_connected_to_telegram: getValue('contact_phone_connected_to_telegram'),
        telegram_username: getValue('telegram_username'),
        email: getValue('email'),
        curated_group_numbers: collectList('curated_group_numbers'),
        curator_primary_building: getValue('curator_primary_building'),
        curator_primary_room: getValue('curator_primary_room'),
        institute_or_faculty: collectFaculties(),
        held_minimum_three_curator_sessions_in_reporting_period: heldMinimumThreeCuratorSessions,
        curator_hours_details: heldMinimumThreeCuratorSessions ? collectCuratorHoursRows() : [],
        manages_group_chat: getBooleanRadio('manages_group_chat'),
        inform_group_about_events: getBooleanRadio('inform_group_about_events'),
        achievements: getBooleanRadio('inform_group_about_events') ? collectAchievements() : [],
        participated_in_two_events_with_group: getBooleanRadio('participated_in_two_events_with_group'),
        joint_participation_events: getBooleanRadio('participated_in_two_events_with_group')
          ? collectJointEvents()
          : [],
        participated_in_two_curator_events: participatedInCuratorEvents,
        curator_personal_events: participatedInCuratorEvents ? collectExtracurricularRows() : [],
        personal_program_participation: collectPersonalProgramRows(),
        mentor_support_events: collectMentorSupportRows(),
        scientific_publications: collectScientificWorks(),
        media_materials: collectInterviews(),
        qualification_courses: collectQualificationCourses(),
      };
    }

    function buildReport() {
      return JSON.stringify(buildReportData(), null, 2);
    }

    function generateFileName(extension = 'json') {
      const [lastName = '', firstName = '', patronymic = ''] = getValue('full_name')
        .split(/\s+/)
        .filter(Boolean);
      const parts = ['Отчёт_о_кураторской_деятельности'];

      if (firstName) parts.push(firstName);
      if (lastName) parts.push(lastName);
      if (patronymic) parts.push(patronymic);

      return `${parts.join('_')}.${extension}`;
    }

    function formatBoolean(value) {
      if (value === true) return 'Да';
      if (value === false) return 'Нет';
      return '—';
    }

    function formatList(items, fallback = '—') {
      if (!Array.isArray(items) || !items.length) return fallback;
      return items.join(', ');
    }

    function formatDateRange(start, end) {
      if (start && end) return `${start} — ${end}`;
      return start || end || '—';
    }

    function formatReportingPeriod(period) {
      if (!period) return '';

      const display = period.display || '';
      if (display) return display;

      const range = formatDateRange(period.date_start, period.date_end);
      const hasRange = range && range !== '—';

      if (period.label && hasRange) {
        return `${period.label}: ${range}${period.deadline ? ` (Прислать отчёт до ${period.deadline})` : ''}`;
      }

      if (hasRange) {
        return `${range}${period.deadline ? ` (Прислать отчёт до ${period.deadline})` : ''}`;
      }

      return period.deadline || '';
    }

    function buildPdfContent(data) {
      const lines = [];

      const addLine = (question, answer) => {
        const safeAnswer = answer ?? '—';
        lines.push({ text: `${question}: ${safeAnswer || '—'}` });
      };

      const addList = (question, items, formatter) => {
        if (!Array.isArray(items) || items.length === 0) {
          addLine(question, '—');
          return;
        }

        lines.push({ text: question });
        lines.push({ ul: items.map(formatter), margin: [8, 4, 0, 8] });
      };

      addLine('Отчетный период', formatReportingPeriod(data.reporting_period) || '—');
      addLine('1. Фамилия Имя Отчество *', data.full_name);
      addList('2. Должность *', data.job_positions, (position, index) => `${index + 1}. ${position || '—'}`);
      addLine('3. Кафедра *', data.department);
      addLine('4. Контактный телефон (подключенный к Telegram) *', data.contact_phone_connected_to_telegram);
      addLine('5. Ник в Telegram *', data.telegram_username);
      addLine('6. E-mail *', data.email);
      addList(
        '7. Номера курируемых групп *',
        data.curated_group_numbers,
        (group, index) => `${index + 1}. ${group || '—'}`
      );
      addLine('8. Корпус основного пребывания куратора *', data.curator_primary_building);
      addLine('9. Аудитория основного пребывания куратора *', data.curator_primary_room);
      addList(
        '10. Институт/Факультет *',
        data.institute_or_faculty,
        (faculty, index) => `${index + 1}. ${faculty || '—'}`
      );
      addLine(
        '11. Проведение не менее трех кураторских часов за отчетный период *',
        formatBoolean(data.held_minimum_three_curator_sessions_in_reporting_period)
      );
      addList(
        '12. Даты проведения трех и более кураторских часов в течение отчетного периода',
        data.curator_hours_details,
        (hour, index) =>
          `${index + 1}. Группы: ${formatList(hour.groups)}, Специалисты: ${formatList(
            hour.specialists
          )}, Период: ${formatDateRange(hour.date_start, hour.date_end)}, Направления: ${formatList(
            hour.directions
          )}, Тема: ${hour.topic || '—'}`
      );
      addLine(
        '13. Ведение чата с каждой группой или общего чата со всеми группами *',
        formatBoolean(data.manages_group_chat)
      );
      addLine(
        '14. Информирование группы о мероприятиях и событиях различного уровня *',
        formatBoolean(data.inform_group_about_events)
      );
      addList(
        '15. Призовое место обучающегося во внеучебных мероприятиях, конкурсах, получение грантов',
        data.achievements,
        (achievement, index) =>
          `${index + 1}. Период: ${formatDateRange(achievement.date_start, achievement.date_end)}, ` +
          `Событие: ${achievement.event || '—'}, группа: ${achievement.group || '—'}, студент(ы): ${
            achievement.student || '—'
          }, результат: ${achievement.result || '—'}`
      );
      addLine(
        '16. Совместное участие с группой не менее чем в двух мероприятиях в течение отчетного периода *',
        formatBoolean(data.participated_in_two_events_with_group)
      );
      addList(
        '17. Даты проведения двух и более мероприятий в течение отчетного периода',
        data.joint_participation_events,
        (event, index) =>
          `${index + 1}. Группы: ${formatList(event.groups)}, Период: ${formatDateRange(
            event.date_start,
            event.date_end
          )}, Мероприятие: ${event.event || '—'}`
      );
      addLine(
        '18. Участие не менее чем в двух мероприятиях  для кураторов: собрания, совещания,  тренинги, мастер-классы, конкурс кураторов *',
        formatBoolean(data.participated_in_two_curator_events)
      );
      addList(
        '19. Даты участия не менее чем в двух мероприятиях  для кураторов: собрания, совещания, тренинги, мастер-классы, конкурс кураторов',
        data.curator_personal_events,
        (event, index) =>
          `${index + 1}. Период: ${formatDateRange(event.date_start, event.date_end)}, Мероприятие: ${
            event.event || '—'
          }`
      );
      addList(
        '20. Личное участие в региональных, межмуниципальных, федеральных программах, конкурсах, мероприятиях по работе с детьми и молодежью, воспитательной работе, молодежной политике (форумы, «Голос поколения», конкурс кураторов РГПУ им. Герцена и т.д.)',
        data.personal_program_participation,
        (event, index) =>
          `${index + 1}. Период: ${formatDateRange(event.date_start, event.date_end)}, Мероприятие: ${
            event.event || '—'
          }`
      );
      addList(
        '21. Участие куратора в роли наставника проекта, а также в подготовке к чемпионату, конкурсу, конференции и др.',
        data.mentor_support_events,
        (event, index) =>
          `${index + 1}. Период: ${formatDateRange(event.date_start, event.date_end)}, Мероприятие: ${
            event.event || '—'
          }, группа: ${event.group || '—'}, студент(ы): ${event.student || '—'}, результат: ${
            event.result || '—'
          }`
      );
      addList(
        '22. Опубликование научной работы (в том числе монографии, научной статьи, доклада, тезисов доклада и т.д. на темы, связанные с молодежной политикой и воспитательной деятельностью, с указанием принадлежности автора к ГУАП (в том числе в форме электронного издания))',
        data.scientific_publications,
        (publication, index) =>
          `${index + 1}. ${publication.description || '—'}${publication.link ? ` — ${publication.link}` : ''}`
      );
      addList(
        '23. Интервью и статьи для «Дзен.ГУАП», соцсетей и сайта ГУАП',
        data.media_materials,
        (material, index) => `${index + 1}. Ссылка: ${material.link || '—'}`
      );
      addList(
        '24. Курсы повышения квалификации в области молодежной политики и воспитательной деятельности',
        data.qualification_courses,
        (course, index) =>
          `${index + 1}. Период: ${formatDateRange(course.date_start, course.date_end)}, Курс: ${
            course.event || '—'
          }`
      );

      return lines;
    }

    function buildPdfDefinition(data) {
      const content = [
        { text: 'Отчёт по кураторской деятельности', style: 'header' },
        { text: formatReportingPeriod(data.reporting_period), style: 'subheader' },
        { text: 'Сводка ответов', style: 'sectionTitle', margin: [0, 12, 0, 6] },
        { stack: buildPdfContent(data), style: 'list' },
      ];

      return {
        info: {
          title: 'Отчёт по кураторской деятельности',
        },
        content,
        defaultStyle: {
          fontSize: 11,
        },
        styles: {
          header: {
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 6],
          },
          subheader: {
            fontSize: 12,
            margin: [0, 0, 0, 12],
          },
          sectionTitle: {
            fontSize: 12,
            bold: true,
          },
          list: {
            lineHeight: 1.4,
          },
        },
      };
    }

    function populateFromJson(data) {
      if (!data || typeof data !== 'object') {
        alert('Не удалось загрузить файл: неверный формат данных.');
        return;
      }

      form.reset();

      curatorHoursRows.innerHTML = '';
      achievementRowsContainer.innerHTML = '';
      jointEventRowsContainer.innerHTML = '';
      extracurricularRowsContainer.innerHTML = '';
      personalProgramRowsContainer.innerHTML = '';
      if (mentorSupportRowsContainer) mentorSupportRowsContainer.innerHTML = '';
      if (scientificWorkRowsContainer) scientificWorkRowsContainer.innerHTML = '';
      if (interviewRowsContainer) interviewRowsContainer.innerHTML = '';
      if (qualificationCourseRowsContainer) qualificationCourseRowsContainer.innerHTML = '';

      selectReportingPeriod(data.reporting_period);
      form.elements.full_name.value = data.full_name || '';
      fillMultiInput('job_positions', Array.isArray(data.job_positions) ? data.job_positions : []);
      form.elements.department.value = data.department || '';
      form.elements.contact_phone_connected_to_telegram.value =
        data.contact_phone_connected_to_telegram || '';
      form.elements.telegram_username.value = data.telegram_username || '';
      form.elements.email.value = data.email || '';
      fillMultiInput(
        'curated_group_numbers',
        Array.isArray(data.curated_group_numbers) ? data.curated_group_numbers : []
      );
      form.elements.curator_primary_building.value = data.curator_primary_building || '';
      form.elements.curator_primary_room.value = data.curator_primary_room || '';

      const faculties = Array.isArray(data.institute_or_faculty) ? data.institute_or_faculty : [];
      form.querySelectorAll('input[name="institute_or_faculty"]').forEach((input) => {
        input.checked = faculties.includes(input.value);
      });

      setRadioValue(
        'held_minimum_three_curator_sessions_in_reporting_period',
        data.held_minimum_three_curator_sessions_in_reporting_period
      );
      curatorHoursRows.innerHTML = '';
      if (data.held_minimum_three_curator_sessions_in_reporting_period) {
        fillCuratorHoursRows(Array.isArray(data.curator_hours_details) ? data.curator_hours_details : []);
      }

      setRadioValue('manages_group_chat', data.manages_group_chat);

      setRadioValue('inform_group_about_events', data.inform_group_about_events);
      achievementRowsContainer.innerHTML = '';
      if (data.inform_group_about_events) {
        fillAchievementRows(Array.isArray(data.achievements) ? data.achievements : []);
      }

      setRadioValue('participated_in_two_events_with_group', data.participated_in_two_events_with_group);
      jointEventRowsContainer.innerHTML = '';
      if (data.participated_in_two_events_with_group) {
        fillJointEventsRows(
          Array.isArray(data.joint_participation_events) ? data.joint_participation_events : []
        );
      }

      setRadioValue('participated_in_two_curator_events', data.participated_in_two_curator_events);
      extracurricularRowsContainer.innerHTML = '';
      if (data.participated_in_two_curator_events) {
        fillExtracurricularRows(
          Array.isArray(data.curator_personal_events) ? data.curator_personal_events : []
        );
      }

      fillPersonalProgramRows(
        Array.isArray(data.personal_program_participation) ? data.personal_program_participation : []
      );
      fillMentorSupportRows(Array.isArray(data.mentor_support_events) ? data.mentor_support_events : []);
      fillScientificWorks(Array.isArray(data.scientific_publications) ? data.scientific_publications : []);
      fillInterviews(Array.isArray(data.media_materials) ? data.media_materials : []);
      fillQualificationCourses(
        Array.isArray(data.qualification_courses) ? data.qualification_courses : []
      );

      toggleCuratorHoursDetails();
      toggleJointActivitiesDetails();
      toggleJointParticipationDetails();
      toggleExtracurricularDetails();
    }

    buildReportingPeriodOptions();
    if (reportingPeriodSelect) {
      reportingPeriodSelect.addEventListener('change', updateManualPeriodFromSelect);
    }
    setupTooltips();

    setupMultiInput({
      name: 'job_positions',
      inputName: 'job_position',
      placeholder: 'Например, преподаватель-практик или тьютор',
    });

    setupMultiInput({
      name: 'curated_group_numbers',
      inputName: 'curated_group_number',
      placeholder: 'Например, 1234 или 4102',
    });

    addCuratorHourRowButton.addEventListener('click', () => addCuratorHourRow());

    if (addAchievementRowButton) {
      addAchievementRowButton.addEventListener('click', () => {
        achievementRowsContainer.append(createAchievementRow());
      });
    }

    if (addJointEventRowButton) {
      addJointEventRowButton.addEventListener('click', () => {
        jointEventRowsContainer.append(createJointEventRow());
      });
    }

    if (addExtracurricularRowButton) {
      addExtracurricularRowButton.addEventListener('click', () => addExtracurricularRow());
    }

    if (addPersonalProgramRowButton) {
      addPersonalProgramRowButton.addEventListener('click', () => addPersonalProgramRow());
    }

    if (addMentorSupportRowButton) {
      addMentorSupportRowButton.addEventListener('click', () => {
        mentorSupportRowsContainer.append(createMentorSupportRow());
        setupTooltips();
      });
    }

    if (addScientificWorkRowButton) {
      addScientificWorkRowButton.addEventListener('click', () => {
        addScientificWorkRow();
      });
    }

    if (addInterviewRowButton) {
      addInterviewRowButton.addEventListener('click', () => {
        addInterviewRow();
      });
    }

    if (addQualificationCourseRowButton) {
      addQualificationCourseRowButton.addEventListener('click', () => {
        addQualificationCourseRow();
      });
    }

    form
      .querySelectorAll('input[name="held_minimum_three_curator_sessions_in_reporting_period"]')
      .forEach((radio) => radio.addEventListener('change', toggleCuratorHoursDetails));

    form
      .querySelectorAll('input[name="inform_group_about_events"]')
      .forEach((radio) => radio.addEventListener('change', toggleJointActivitiesDetails));

    form
      .querySelectorAll('input[name="participated_in_two_events_with_group"]')
      .forEach((radio) => radio.addEventListener('change', toggleJointParticipationDetails));

    form
      .querySelectorAll('input[name="participated_in_two_curator_events"]')
      .forEach((radio) => radio.addEventListener('change', toggleExtracurricularDetails));

    toggleCuratorHoursDetails();
    toggleJointActivitiesDetails();
    toggleJointParticipationDetails();
    toggleExtracurricularDetails();

    if (importButton && importInput) {
      importButton.addEventListener('click', () => importInput.click());
      importInput.addEventListener('change', () => {
        const [file] = importInput.files || [];
        if (!file) return;

        file
          .text()
          .then((content) => {
            let data;
            try {
              data = JSON.parse(content);
            } catch (error) {
              alert('Не удалось прочитать файл: неверный JSON.');
              return;
            }

            populateFromJson(data);
          })
          .catch(() => {
            alert('Не удалось прочитать файл. Попробуйте еще раз.');
          })
          .finally(() => {
            importInput.value = '';
          });
      });
    }

    if (exportJsonButton) {
      exportJsonButton.addEventListener('click', () => {
        const reportData = buildReportData();
        const report = JSON.stringify(reportData, null, 2);
        const blob = new Blob([report], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = generateFileName('json');
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      });
    }

    if (exportPdfButton) {
      exportPdfButton.addEventListener('click', () => {
        const reportData = buildReportData();
        const pdfDefinition = buildPdfDefinition(reportData);
        pdfMake.createPdf(pdfDefinition).download(generateFileName('pdf'));
      });
    }
  </script>
</body>
</html>
